<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>åŒ»è€ƒç»ƒä¹ </title>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS å˜é‡ / ä¸»é¢˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root,[data-theme="dark"]{
  --bg:         #0d1117;
  --surface:    #161b22;
  --card:       #21262d;
  --border:     #30363d;
  --text:       #e6edf3;
  --muted:      #7d8590;
  --accent:     #4493f8;
  --accent-bg:  rgba(68,147,248,.12);
  --success:    #3fb950;
  --success-bg: rgba(63,185,80,.12);
  --danger:     #f85149;
  --danger-bg:  rgba(248,81,73,.12);
  --warning:    #d29922;
  --warn-bg:    rgba(210,153,34,.12);
  --shadow:     0 8px 32px rgba(0,0,0,.5);
  --shadow-sm:  0 2px 8px rgba(0,0,0,.4);
  --r:          14px;
}
[data-theme="light"]{
  --bg:         #f0f4f8;
  --surface:    #ffffff;
  --card:       #f6f8fa;
  --border:     #d0d7de;
  --text:       #1f2328;
  --muted:      #656d76;
  --accent:     #0969da;
  --accent-bg:  rgba(9,105,218,.1);
  --success:    #1a7f37;
  --success-bg: rgba(26,127,55,.1);
  --danger:     #cf222e;
  --danger-bg:  rgba(207,34,46,.1);
  --warning:    #9a6700;
  --warn-bg:    rgba(154,103,0,.1);
  --shadow:     0 4px 16px rgba(0,0,0,.12);
  --shadow-sm:  0 2px 6px rgba(0,0,0,.08);
}

/* â”€â”€ Reset â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text)}
body{font-family:'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;font-size:15px;line-height:1.6;transition:background .25s,color .25s}
button{cursor:pointer;font-family:inherit;border:none;outline:none}
input,select{font-family:inherit;outline:none}

/* â”€â”€ Screens â”€â”€ */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;overflow:hidden;
  opacity:0;pointer-events:none;transition:opacity .22s,transform .22s}
.screen.active{opacity:1;pointer-events:auto;transform:none!important}
.screen.slide-left{transform:translateX(-100%)}
.screen.slide-right{transform:translateX(100%)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-home{background:var(--bg);overflow-y:auto}

.home-hero{
  background:linear-gradient(160deg,rgba(68,147,248,.18) 0%,transparent 60%);
  padding:env(safe-area-inset-top,0) 0 0;
}
.home-topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 20px 12px;
}
.home-brand{display:flex;align-items:center;gap:10px}
.brand-icon{
  width:38px;height:38px;border-radius:10px;
  background:var(--accent);display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:900;color:#fff;letter-spacing:-.5px;
  box-shadow:0 4px 12px rgba(68,147,248,.4);
}
.brand-name{font-size:20px;font-weight:700;letter-spacing:-.3px}
.brand-sub{font-size:11px;color:var(--muted);margin-top:1px}

.icon-btn{
  width:36px;height:36px;border-radius:10px;background:var(--card);
  border:1px solid var(--border);color:var(--muted);font-size:16px;
  display:flex;align-items:center;justify-content:center;transition:all .15s;
}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}

.bank-card{
  margin:0 20px 24px;padding:14px 18px;
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
}
.bank-card-name{font-size:13px;color:var(--muted);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.bank-card-name svg{opacity:.6}
.bank-stats-row{display:flex;gap:0}
.bank-stat{flex:1;text-align:center;border-right:1px solid var(--border)}
.bank-stat:last-child{border-right:none}
.bank-stat-num{font-size:22px;font-weight:700;color:var(--accent)}
.bank-stat-label{font-size:11px;color:var(--muted);margin-top:2px}

.section-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;padding:0 20px 10px}

/* Mode cards */
.mode-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;padding:0 20px 20px}
.mode-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:18px 14px;cursor:pointer;transition:all .2s;
  display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center;
}
.mode-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow)}
.mode-card:active{transform:translateY(0)}
.mode-emoji{font-size:28px;line-height:1}
.mode-title{font-size:14px;font-weight:600}
.mode-desc{font-size:11px;color:var(--muted);line-height:1.4}
.mode-card.practice{--mc: var(--accent)}
.mode-card.exam{--mc: var(--warning)}
.mode-card.memo{--mc: var(--success)}
.mode-card:hover .mode-emoji{transform:scale(1.1);transition:transform .2s}

/* Recent */
.recent-list{padding:0 20px 32px;display:flex;flex-direction:column;gap:8px}
.recent-item{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:12px 16px;cursor:pointer;transition:border-color .15s;
}
.recent-item:hover{border-color:var(--accent)}
.recent-info{display:flex;flex-direction:column;gap:2px}
.recent-name{font-size:13px;font-weight:500}
.recent-meta{font-size:11px;color:var(--muted)}
.recent-score{font-size:18px;font-weight:700;color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-config{background:var(--bg)}
.config-header{
  display:flex;align-items:center;gap:12px;
  padding:max(env(safe-area-inset-top),16px) 16px 14px;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.back-btn{
  width:36px;height:36px;border-radius:9px;background:var(--card);
  border:1px solid var(--border);color:var(--text);font-size:18px;
  display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;
}
.back-btn:hover{border-color:var(--accent);color:var(--accent)}
.config-title{flex:1}
.config-title h2{font-size:17px;font-weight:700}
.config-title .sub{font-size:12px;color:var(--muted)}
.mode-badge{
  padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;
}
.mode-badge.practice{background:var(--accent-bg);color:var(--accent)}
.mode-badge.exam{background:var(--warn-bg);color:var(--warning)}
.mode-badge.memo{background:var(--success-bg);color:var(--success)}

.config-body{flex:1;overflow-y:auto;padding:20px}
.config-section{margin-bottom:24px}
.config-section-label{font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px}

/* Chips */
.chip-wrap{display:flex;flex-wrap:wrap;gap:8px}
.chip{
  padding:6px 14px;border-radius:20px;font-size:13px;
  background:var(--card);border:1.5px solid var(--border);color:var(--muted);
  cursor:pointer;transition:all .15s;user-select:none;
}
.chip:hover{border-color:var(--accent);color:var(--text)}
.chip.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:600}
.chip.active.exam-chip{background:var(--warning);border-color:var(--warning)}
.chip.active.memo-chip{background:var(--success);border-color:var(--success)}

/* Count slider */
.count-row{display:flex;align-items:center;gap:14px}
.count-val{
  font-size:28px;font-weight:700;color:var(--accent);min-width:60px;text-align:center;
  font-variant-numeric:tabular-nums;
}
.slider-wrap{flex:1}
input[type=range]{
  width:100%;height:4px;border-radius:2px;
  -webkit-appearance:none;appearance:none;
  background:var(--border);cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:20px;height:20px;border-radius:50%;
  background:var(--accent);box-shadow:0 2px 6px rgba(68,147,248,.4);
  transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:active{transform:scale(1.2)}

/* Toggle switch */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.toggle-row label{font-size:14px;color:var(--text)}
.toggle-row .desc{font-size:12px;color:var(--muted);margin-top:2px}
.toggle{
  position:relative;width:44px;height:26px;flex-shrink:0;
}
.toggle input{opacity:0;width:0;height:0}
.toggle-track{
  position:absolute;inset:0;border-radius:13px;
  background:var(--border);cursor:pointer;transition:background .2s;
}
.toggle input:checked ~ .toggle-track{background:var(--accent)}
.toggle-thumb{
  position:absolute;top:3px;left:3px;width:20px;height:20px;
  background:#fff;border-radius:50%;transition:transform .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.3);pointer-events:none;
}
.toggle input:checked ~ .toggle-thumb{transform:translateX(18px)}

.config-footer{
  padding:16px 20px max(env(safe-area-inset-bottom),20px);
  background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;
}
.start-btn{
  width:100%;padding:16px;border-radius:var(--r);font-size:16px;font-weight:700;
  color:#fff;letter-spacing:.02em;transition:all .2s;
  background:linear-gradient(135deg,var(--accent),#6177f9);
  box-shadow:0 4px 16px rgba(68,147,248,.4);
}
.start-btn:hover{opacity:.9;transform:translateY(-1px)}
.start-btn:active{transform:translateY(0)}
.start-btn.exam-start{background:linear-gradient(135deg,var(--warning),#e8882a)}
.start-btn.memo-start{background:linear-gradient(135deg,var(--success),#26a57a)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUIZ SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-quiz{background:var(--bg)}

.quiz-header{
  display:flex;align-items:center;gap:10px;
  padding:max(env(safe-area-inset-top),14px) 14px 12px;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.quiz-progress-wrap{flex:1;display:flex;flex-direction:column;gap:5px}
.quiz-progress-text{display:flex;justify-content:space-between;align-items:baseline}
.quiz-progress-cur{font-size:15px;font-weight:700}
.quiz-progress-total{font-size:12px;color:var(--muted)}
.progress-bar{height:3px;border-radius:2px;background:var(--border);overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .3s ease}
.progress-fill.exam-fill{background:var(--warning)}
.progress-fill.memo-fill{background:var(--success)}

.quiz-timer{
  display:flex;align-items:center;gap:5px;
  font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;
  color:var(--muted);padding:4px 10px;border-radius:8px;
  background:var(--card);border:1px solid var(--border);
}
.quiz-timer.urgent{color:var(--danger);border-color:var(--danger);animation:pulse-timer 1s infinite}
.flag-btn{
  width:34px;height:34px;border-radius:9px;background:var(--card);
  border:1px solid var(--border);color:var(--muted);font-size:16px;
  display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;
}
.flag-btn.active{background:var(--warn-bg);border-color:var(--warning);color:var(--warning)}

/* Question body */
.quiz-body{flex:1;overflow:hidden;position:relative}
/* æ¯æ¬¡åˆ‡é¢˜æ—¶å†…å®¹åœ¨ q-stage å†…æ»šåŠ¨ */
.q-stage{
  position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;
  will-change:transform,opacity;
}
.question-wrap{padding:16px 16px 24px;max-width:720px;margin:0 auto}

/* â”€â”€ é¢˜ç›®åˆ‡æ¢åŠ¨ç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@keyframes q-exit-left  {to{transform:translateX(-38%) scale(.96);opacity:0}}
@keyframes q-exit-right {to{transform:translateX( 38%) scale(.96);opacity:0}}
@keyframes q-enter-right{from{transform:translateX(38%) scale(.96);opacity:0}}
@keyframes q-enter-left {from{transform:translateX(-38%) scale(.96);opacity:0}}

.q-stage.exit-left  {animation:q-exit-left  .22s cubic-bezier(.4,0,1,1) forwards;pointer-events:none}
.q-stage.exit-right {animation:q-exit-right .22s cubic-bezier(.4,0,1,1) forwards;pointer-events:none}
.q-stage.enter-right{animation:q-enter-right .22s cubic-bezier(0,0,.2,1) forwards}
.q-stage.enter-left {animation:q-enter-left  .22s cubic-bezier(0,0,.2,1) forwards}

/* â”€â”€ èƒŒé¢˜å¡ç‰‡æ»‘åŠ¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.memo-card-wrap{width:100%;max-width:700px;position:relative;flex-shrink:0;min-height:80px}
/* å¡ç‰‡ç»å¯¹å®šä½åœ¨ wrap å†…ï¼Œé  JS åŠ¨æ€è®¾é«˜åº¦ */
.memo-card{
  width:100%;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  box-shadow:var(--shadow);overflow:hidden;
}
.memo-card.memo-exit-left  {animation:q-exit-left  .2s cubic-bezier(.4,0,1,1) forwards;pointer-events:none}
.memo-card.memo-exit-right {animation:q-exit-right .2s cubic-bezier(.4,0,1,1) forwards;pointer-events:none}
.memo-card.memo-enter-right{animation:q-enter-right .22s cubic-bezier(0,0,.2,1) forwards}
.memo-card.memo-enter-left {animation:q-enter-left  .22s cubic-bezier(0,0,.2,1) forwards}

.q-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.q-tag{
  font-size:11px;padding:3px 8px;border-radius:5px;font-weight:500;
}
.q-tag.mode-tag{background:var(--accent-bg);color:var(--accent)}
.q-tag.unit-tag{background:var(--card);color:var(--muted);border:1px solid var(--border)}
.q-tag.rate-tag{background:var(--warn-bg);color:var(--warning)}
.q-tag.rate-tag.easy{background:var(--success-bg);color:var(--success)}

.q-stem{
  background:var(--surface);border:1px solid var(--border);border-radius:10px;
  padding:14px 16px;margin-bottom:16px;font-size:14px;line-height:1.8;color:var(--text);
  border-left:3px solid var(--accent);box-shadow:inset 0 0 0 1px transparent;
}
.q-stem-label{
  font-size:10px;font-weight:700;color:var(--accent);text-transform:uppercase;
  letter-spacing:.08em;margin-bottom:8px;display:flex;align-items:center;gap:5px;
}
.q-stem-label::after{
  content:'';flex:1;height:1px;background:var(--accent);opacity:.25;
}

.q-text{font-size:16px;line-height:1.8;color:var(--text);margin-bottom:18px;font-weight:500;letter-spacing:.01em}
.q-num{
  display:inline-flex;align-items:center;justify-content:center;
  width:24px;height:24px;border-radius:6px;background:var(--accent);
  color:#fff;font-size:12px;font-weight:700;margin-right:8px;flex-shrink:0;
  vertical-align:middle;
}

/* Options */
.options-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
.opt{
  display:flex;align-items:flex-start;gap:12px;
  background:var(--card);border:2px solid var(--border);border-radius:12px;
  padding:13px 14px;cursor:pointer;transition:all .18s;text-align:left;width:100%;
}
.opt:hover:not(:disabled){border-color:var(--accent);background:var(--accent-bg)}
.opt:active:not(:disabled){transform:scale(.99)}
.opt:disabled{cursor:default}
.opt-label{
  width:30px;height:30px;border-radius:8px;flex-shrink:0;
  background:var(--border);color:var(--muted);
  display:flex;align-items:center;justify-content:center;
  font-size:13px;font-weight:700;transition:all .18s;
}
.opt-text{font-size:15px;line-height:1.65;padding-top:3px;flex:1;text-align:left;color:var(--text)}

/* Option states */
.opt.selected{border-color:var(--accent);background:var(--accent-bg)}
.opt.selected .opt-label{background:var(--accent);color:#fff}
.opt.correct{border-color:var(--success);background:var(--success-bg);animation:pop-in .25s ease}
.opt.correct .opt-label{background:var(--success);color:#fff}
.opt.wrong{border-color:var(--danger);background:var(--danger-bg);animation:shake .28s ease}
.opt.wrong .opt-label{background:var(--danger);color:#fff}
.opt.dim{opacity:.5}

/* Explanation */
.explain-panel{
  max-height:0;overflow:hidden;
  transition:max-height .4s cubic-bezier(.4,0,.2,1),opacity .3s;
  opacity:0;
}
.explain-panel.open{max-height:600px;opacity:1}

.explain-inner{
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;margin-bottom:16px;
}
.explain-result{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px;border-bottom:1px solid var(--border);
}
.explain-result.ok{background:var(--success-bg)}
.explain-result.err{background:var(--danger-bg)}
.result-icon{font-size:20px}
.result-title{font-size:15px;font-weight:700}
.result-title.ok{color:var(--success)}
.result-title.err{color:var(--danger)}
.explain-correct-row{
  font-size:13px;color:var(--muted);
  padding:8px 16px;border-bottom:1px solid var(--border);background:var(--surface);
}
.explain-correct-row span{color:var(--success);font-weight:600}
.explain-body{padding:14px 16px;font-size:14px;line-height:1.85;color:var(--text)}
.explain-point{
  margin-top:12px;padding:10px 14px;
  background:var(--accent-bg);border-radius:8px;
  font-size:13px;color:var(--text);border-left:3px solid var(--accent);
}
.explain-point span{color:var(--accent);font-weight:700}

/* Quiz footer */
.quiz-footer{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px max(env(safe-area-inset-bottom),14px);
  background:var(--surface);border-top:1px solid var(--border);flex-shrink:0;
}
.nav-btn{
  padding:11px 20px;border-radius:10px;font-size:14px;font-weight:600;
  background:var(--card);border:1px solid var(--border);color:var(--text);
  transition:all .15s;
}
.nav-btn:hover{border-color:var(--accent);color:var(--accent)}
.nav-btn:disabled{opacity:.35;cursor:default}
.nav-btn.primary{
  flex:1;background:linear-gradient(135deg,var(--accent),#6177f9);
  border:none;color:#fff;font-size:15px;
  box-shadow:0 3px 10px rgba(68,147,248,.3);
}
.nav-btn.primary:hover{opacity:.9}
.nav-btn.primary:disabled{background:var(--border);box-shadow:none;opacity:.5}
.nav-btn.primary.exam{background:linear-gradient(135deg,var(--warning),#e8882a)}
.nav-btn.primary.memo-good{background:linear-gradient(135deg,var(--success),#26a57a)}
.nav-btn.primary.memo-again{background:var(--card);border:1px solid var(--border);color:var(--muted)}

/* Question grid (exam mode mini-map) */
.q-grid-toggle{
  font-size:13px;color:var(--muted);padding:8px 16px;
  background:var(--card);border:1px solid var(--border);border-radius:9px;
  transition:all .15s;white-space:nowrap;
}
.q-grid-toggle:hover{border-color:var(--accent);color:var(--accent)}
.q-grid-panel{
  max-height:0;overflow:hidden;transition:max-height .3s;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.q-grid-panel.open{max-height:200px}
.q-grid-inner{padding:10px 14px;display:flex;flex-wrap:wrap;gap:6px;overflow-y:auto;max-height:180px}
.q-dot{
  width:32px;height:32px;border-radius:7px;font-size:11px;font-weight:700;
  background:var(--card);border:1.5px solid var(--border);color:var(--muted);
  display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s;
}
.q-dot:hover{border-color:var(--accent)}
.q-dot.answered{background:var(--accent-bg);border-color:var(--accent);color:var(--accent)}
.q-dot.flagged{background:var(--warn-bg);border-color:var(--warning);color:var(--warning)}
.q-dot.cur{background:var(--accent);border-color:var(--accent);color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEMO SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-memo{background:var(--bg)}
.memo-body{
  flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;
  padding:16px 16px max(env(safe-area-inset-bottom),24px);
  display:flex;flex-direction:column;align-items:center;gap:14px;
}

/* è¿›åº¦ç»Ÿè®¡è¡Œ */
.memo-stats-row{
  display:flex;align-items:center;justify-content:center;gap:20px;
  font-size:12px;color:var(--muted);width:100%;max-width:700px;flex-shrink:0;
}
.memo-stat-item{display:flex;align-items:center;gap:5px}
.memo-stat-dot{width:8px;height:8px;border-radius:50%}
.memo-stat-dot.known{background:var(--success)}
.memo-stat-dot.again-dot{background:var(--danger)}
.memo-stat-dot.left{background:var(--border)}
.memo-stat-num{font-weight:700;color:var(--text)}

/* ä¸»å¡ç‰‡ */
.memo-card{
  width:100%;max-width:700px;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  box-shadow:var(--shadow);overflow:hidden;flex-shrink:0;
}

/* é¢˜ç›®åŒº */
.memo-card-question{
  padding:22px 22px 18px;
  border-bottom:2px solid var(--border);
}
.memo-card-meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.memo-stem-block{
  font-size:13px;color:var(--text);line-height:1.7;
  padding:10px 14px;margin-bottom:12px;
  background:var(--card);border-radius:8px;border-left:3px solid var(--accent);
  opacity:.9;
}
.memo-q-text{font-size:16px;font-weight:500;line-height:1.8;color:var(--text)}
.memo-opts{display:flex;flex-direction:column;gap:6px;margin-top:14px}
.memo-opt{
  display:flex;align-items:flex-start;gap:10px;padding:10px 14px;
  border-radius:9px;background:var(--card);border:1.5px solid var(--border);
  font-size:14px;line-height:1.6;color:var(--text);transition:all .25s;
}
.memo-opt.is-answer{border-color:var(--success);background:var(--success-bg)}
.memo-opt.is-answer .memo-opt-label{background:var(--success);color:#fff}
.memo-opt-label{
  width:26px;height:26px;border-radius:7px;background:var(--border);
  color:var(--muted);display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;flex-shrink:0;transition:all .25s;
}

/* ç­”æ¡ˆåŒºï¼ˆä¸‹æ»‘æ­ç¤ºï¼‰ */
.memo-card-answer{
  border-top:2px dashed var(--border);
  max-height:0;overflow:hidden;
  transition:max-height .45s cubic-bezier(.4,0,.2,1),opacity .3s;
  opacity:0;
}
.memo-card-answer.revealed{max-height:1000px;opacity:1}
.memo-answer-inner{padding:20px 22px}
.memo-answer-label{
  font-size:11px;font-weight:700;color:var(--success);letter-spacing:.08em;
  text-transform:uppercase;margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.memo-answer-label::after{content:'';flex:1;height:1px;background:var(--success);opacity:.3}
.memo-explain-text{font-size:14px;line-height:1.85;color:var(--text);margin-bottom:10px}
.memo-explain-point{
  font-size:12px;color:var(--muted);padding:8px 12px;
  background:var(--card);border-radius:7px;border-left:3px solid var(--accent);
}

/* æ­ç¤ºæŒ‰é’® */
.memo-reveal-btn{
  width:100%;max-width:700px;padding:15px;flex-shrink:0;
  border-radius:12px;font-size:15px;font-weight:700;
  background:linear-gradient(135deg,var(--accent),#6177f9);
  color:#fff;box-shadow:0 4px 14px rgba(68,147,248,.35);transition:all .2s;
}
.memo-reveal-btn:hover{opacity:.92;transform:translateY(-1px)}
.memo-reveal-btn:active{transform:none}
.memo-reveal-btn.hidden{display:none}

/* è‡ªè¯„æŒ‰é’® */
.memo-rate-row{display:flex;gap:12px;width:100%;max-width:700px;flex-shrink:0}
.memo-rate-row.hidden{display:none}
.memo-rate-btn{
  flex:1;padding:14px;border-radius:12px;font-size:14px;font-weight:700;
  transition:all .2s;border:2px solid;
}
.memo-rate-btn.again{background:var(--danger-bg);color:var(--danger);border-color:var(--danger)}
.memo-rate-btn.again:hover{background:var(--danger);color:#fff}
.memo-rate-btn.know{background:var(--success-bg);color:var(--success);border-color:var(--success)}
.memo-rate-btn.know:hover{background:var(--success);color:#fff}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESULTS SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-results{background:var(--bg);display:flex;flex-direction:column;overflow:hidden}

.results-header{
  display:flex;align-items:center;gap:12px;
  padding:max(env(safe-area-inset-top),16px) 20px 14px;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.results-header h2{font-size:17px;font-weight:700}

/* ä¸»æ»šåŠ¨å®¹å™¨ */
.results-scroll{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}

/* PCï¼šä¸¤æ ç­‰é«˜å¸ƒå±€ï¼›Mobileï¼šå•åˆ— */
.results-layout{
  display:grid;
  grid-template-columns:1fr;
  gap:20px;
  padding:24px 20px max(env(safe-area-inset-bottom),24px);
  max-width:1100px;margin:0 auto;
}
@media(min-width:780px){
  .results-layout{
    grid-template-columns:340px 1fr;
    align-items:start;
    padding:32px 32px max(env(safe-area-inset-bottom),32px);
  }
}

/* å·¦æ ï¼šå¾—åˆ†å¡ */
.score-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  overflow:hidden;
}
.score-card-top{
  display:flex;flex-direction:column;align-items:center;
  padding:32px 24px 24px;
  background:linear-gradient(160deg,var(--accent-bg) 0%,transparent 70%);
  border-bottom:1px solid var(--border);
}
.score-ring-wrap{position:relative;width:180px;height:180px;margin-bottom:20px}
.score-ring{transform:rotate(-90deg)}
.ring-bg{fill:none;stroke:var(--border);stroke-width:10}
.ring-fill{
  fill:none;stroke-width:10;stroke-linecap:round;stroke:var(--accent);
  stroke-dasharray:1005;stroke-dashoffset:1005;
  transition:stroke-dashoffset 1.4s cubic-bezier(.35,0,.2,1);
}
.ring-fill.pass{stroke:var(--success)}
.ring-fill.fail{stroke:var(--danger)}
.score-center{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
}
.score-pct{font-size:44px;font-weight:800;line-height:1;font-variant-numeric:tabular-nums}
.score-label{font-size:12px;color:var(--muted);margin-top:4px;letter-spacing:.05em}
.score-verdict{font-size:22px;font-weight:700;margin-bottom:4px}
.score-sub{font-size:13px;color:var(--muted);text-align:center}

/* å¾—åˆ†å¡åº•éƒ¨ï¼š4 æ ¼ç»Ÿè®¡ */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:0}
.stat-cell{
  padding:16px 20px;
  border-right:1px solid var(--border);
  border-bottom:1px solid var(--border);
}
.stat-cell:nth-child(2n){border-right:none}
.stat-cell:nth-child(n+3){border-bottom:none}
.stat-cell-label{font-size:11px;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:5px}
.stat-cell-val{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums}
.stat-cell-val.ok{color:var(--success)}
.stat-cell-val.err{color:var(--danger)}
.stat-cell-val.accent{color:var(--accent)}
.stat-cell-val.warn{color:var(--warning)}

/* å³æ  */
.results-right{display:flex;flex-direction:column;gap:16px}

.unit-breakdown{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r);
  padding:20px 20px 16px;
}
.unit-breakdown h3{
  font-size:12px;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.08em;margin-bottom:14px;
}
.unit-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.unit-row:last-child{margin-bottom:0}
.unit-name{font-size:13px;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
.unit-bar-wrap{width:80px;height:5px;background:var(--border);border-radius:3px;flex-shrink:0}
.unit-bar{height:100%;border-radius:3px;transition:width .8s ease}
.unit-pct{font-size:12px;font-weight:700;width:38px;text-align:right;flex-shrink:0;font-variant-numeric:tabular-nums}

.results-actions{display:flex;flex-direction:column;gap:10px}
.res-btn{
  width:100%;padding:14px 20px;border-radius:12px;font-size:15px;font-weight:700;
  transition:all .2s;text-align:center;
}
.res-btn.primary{
  background:linear-gradient(135deg,var(--accent),#6177f9);
  color:#fff;box-shadow:0 4px 14px rgba(68,147,248,.35);
}
.res-btn.primary:hover{opacity:.92;transform:translateY(-1px)}
.res-btn.primary:active{transform:none}
.res-btn.ghost{
  background:var(--surface);border:1px solid var(--border);color:var(--text);
}
.res-btn.ghost:hover{border-color:var(--accent);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REVIEW SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-review{background:var(--bg)}
.review-header{
  display:flex;align-items:center;gap:12px;
  padding:max(env(safe-area-inset-top),14px) 16px 12px;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.review-tabs{
  display:flex;gap:4px;padding:10px 16px;
  background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;
}
.rtab{
  padding:6px 16px;border-radius:20px;font-size:13px;font-weight:500;
  background:transparent;color:var(--muted);border:1px solid transparent;
  transition:all .15s;cursor:pointer;
}
.rtab.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent)}
.rtab.wrong-tab.active{background:var(--danger-bg);border-color:var(--danger);color:var(--danger)}
.rtab.ok-tab.active{background:var(--success-bg);border-color:var(--success);color:var(--success)}

.review-list{flex:1;overflow-y:auto;padding:12px 16px}
.review-item{
  background:var(--card);border:1px solid var(--border);border-radius:12px;
  margin-bottom:10px;overflow:hidden;cursor:pointer;
}
.review-item-head{
  display:flex;align-items:center;gap:10px;padding:12px 14px;
}
.review-item-head:hover{background:var(--surface)}
.review-dot{
  width:10px;height:10px;border-radius:50%;flex-shrink:0;
}
.review-dot.ok{background:var(--success)}
.review-dot.err{background:var(--danger)}
.review-dot.skip{background:var(--border)}
.review-item-q{flex:1;font-size:13px;line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.review-ans{font-size:12px;font-weight:700;width:20px;text-align:center;flex-shrink:0}
.review-ans.ok{color:var(--success)}
.review-ans.err{color:var(--danger)}
.review-expand{max-height:0;overflow:hidden;transition:max-height .35s;border-top:0 solid var(--border)}
.review-expand.open{max-height:600px;border-top-width:1px}
.review-expand-inner{padding:14px}
.review-opts-list{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
.review-opt{
  display:flex;align-items:flex-start;gap:8px;padding:8px 10px;
  border-radius:8px;background:var(--surface);border:1.5px solid var(--border);
  font-size:13px;line-height:1.6;
}
.review-opt.is-correct{border-color:var(--success);background:var(--success-bg)}
.review-opt.is-selected.wrong{border-color:var(--danger);background:var(--danger-bg)}
.review-opt-lbl{
  width:22px;height:22px;border-radius:5px;background:var(--border);
  color:var(--muted);display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:700;flex-shrink:0;
}
.review-opt.is-correct .review-opt-lbl{background:var(--success);color:#fff}
.review-opt.is-selected.wrong .review-opt-lbl{background:var(--danger);color:#fff}
.review-discuss{font-size:13px;line-height:1.85;color:var(--text);padding:12px 14px;background:var(--surface);border-radius:8px}
.review-discuss strong{color:var(--text)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;bottom:calc(env(safe-area-inset-bottom)+80px);left:50%;
  transform:translateX(-50%) translateY(20px);
  background:var(--surface);border:1px solid var(--border);border-radius:24px;
  padding:9px 20px;font-size:13px;color:var(--text);
  box-shadow:var(--shadow);white-space:nowrap;
  opacity:0;transition:all .25s;pointer-events:none;z-index:999;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* stem æŠ˜å ï¼šé»˜è®¤å±•å¼€ï¼Œç‚¹å‡»ååŠ  .collapsed ç±»æ”¶èµ· */
.q-stem.q-stem-collapsible{cursor:pointer}
.q-stem.q-stem-collapsible .q-stem-label{user-select:none}
.q-stem.q-stem-collapsible .q-stem-content{overflow:hidden;transition:max-height .3s ease,opacity .25s}
.q-stem.q-stem-collapsible.is-collapsed .q-stem-content{max-height:0!important;opacity:0}
.q-stem.q-stem-collapsible:not(.is-collapsed) .q-stem-content{max-height:none;opacity:1}
.stem-toggle-hint{font-size:10px;margin-left:6px;opacity:.65;font-weight:400}
/* æŠ˜å å header å˜æ·¡ */
.q-stem.q-stem-collapsible.is-collapsed{background:var(--card);border-style:dashed;opacity:.75}
.q-stem.q-stem-collapsible.is-collapsed .q-stem-label{color:var(--muted)}
/* å¤šé€‰é¢˜æ ‡è®° */
.multi-badge{
  display:inline-flex;align-items:center;gap:4px;
  font-size:11px;font-weight:700;padding:3px 9px;border-radius:5px;
  background:var(--warn-bg);color:var(--warning);border:1px solid var(--warning);
  letter-spacing:.03em;
}
/* å¤šé€‰å·²é€‰ä¸­çŠ¶æ€ï¼ˆallow toggling, no auto-submitï¼‰ */
.opt.multi-selected{border-color:var(--accent);background:var(--accent-bg)}
.opt.multi-selected .opt-label{background:var(--accent);color:#fff}
/* å¤šé€‰è§£æé‡Œæ˜¾ç¤ºæ‰€æœ‰æ­£ç¡®é€‰é¡¹ */
.explain-correct-row span.multi-ans{color:var(--success);font-weight:700;font-size:14px}
/* æäº¤æŒ‰é’®ï¼ˆå¤šé€‰/è€ƒè¯•ç¡®è®¤ï¼‰ */
.confirm-btn{
  width:100%;padding:13px;border-radius:12px;font-size:15px;font-weight:700;
  background:linear-gradient(135deg,var(--accent),#6177f9);
  color:#fff;margin-top:12px;margin-bottom:4px;
  box-shadow:0 3px 10px rgba(68,147,248,.3);transition:all .2s;
}
.confirm-btn:hover{opacity:.9;transform:translateY(-1px)}
.confirm-btn:active{transform:translateY(0)}
.confirm-btn.exam{background:linear-gradient(135deg,var(--warning),#e8882a)}
.confirm-btn:disabled{background:var(--border);box-shadow:none;opacity:.5;transform:none;cursor:default}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Animations
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes pop-in{
  0%{transform:scale(.96)} 60%{transform:scale(1.02)} 100%{transform:scale(1)}
}
@keyframes shake{
  0%,100%{transform:translateX(0)} 20%{transform:translateX(-5px)} 60%{transform:translateX(5px)}
}
@keyframes pulse-timer{
  0%,100%{opacity:1} 50%{opacity:.5}
}
@keyframes fade-up{
  from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none}
}
.fade-up{animation:fade-up .3s ease both}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Responsive / Mobile
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:600px){
  .mode-grid{grid-template-columns:1fr;gap:10px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .mode-card{flex-direction:row;text-align:left;padding:16px 18px}
  .mode-emoji{font-size:32px}
}
@media(min-width:768px){
  .question-wrap{padding:24px 24px 8px;max-width:700px}
  .mode-grid{grid-template-columns:repeat(3,1fr)}
  .results-layout{padding:32px 40px max(env(safe-area-inset-bottom),32px) 40px}
}
</style>
</head>
<body>

<!-- â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-home" class="screen active">
  <div class="home-hero">
    <div class="home-topbar">
      <div class="home-brand">
        <div class="brand-icon">åŒ»</div>
        <div>
          <div class="brand-name">åŒ»è€ƒç»ƒä¹ </div>
          <div class="brand-sub" id="home-bank-name">åŠ è½½ä¸­â€¦</div>
        </div>
      </div>
      <button class="icon-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
    </div>
    <div class="bank-card">
      <div class="bank-card-name">
        <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor"><path d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z"/></svg>
        é¢˜åº“ç»Ÿè®¡
      </div>
      <div class="bank-stats-row">
        <div class="bank-stat">
          <div class="bank-stat-num" id="stat-sq">â€”</div>
          <div class="bank-stat-label">æ€»é¢˜æ•°</div>
        </div>
        <div class="bank-stat">
          <div class="bank-stat-num" id="stat-units">â€”</div>
          <div class="bank-stat-label">ç« èŠ‚æ•°</div>
        </div>
        <div class="bank-stat">
          <div class="bank-stat-num" id="stat-modes">â€”</div>
          <div class="bank-stat-label">é¢˜å‹æ•°</div>
        </div>
      </div>
    </div>
  </div>
  <div class="section-label">é€‰æ‹©æ¨¡å¼</div>
  <div class="mode-grid" style="padding:0 20px 32px">
    <div class="mode-card practice" onclick="openConfig('practice')">
      <div class="mode-emoji">âœï¸</div>
      <div>
        <div class="mode-title">ç»ƒä¹ æ¨¡å¼</div>
        <div class="mode-desc">å³æ—¶åé¦ˆ<br>è¾¹åšè¾¹å­¦</div>
      </div>
    </div>
    <div class="mode-card exam" onclick="openConfig('exam')">
      <div class="mode-emoji">â±</div>
      <div>
        <div class="mode-title">è€ƒè¯•æ¨¡å¼</div>
        <div class="mode-desc">è®¡æ—¶é™æ—¶<br>æ¨¡æ‹Ÿæ­£å¼è€ƒè¯•</div>
      </div>
    </div>
    <div class="mode-card memo" onclick="openConfig('memo')">
      <div class="mode-emoji">ğŸ§ </div>
      <div>
        <div class="mode-title">èƒŒé¢˜æ¨¡å¼</div>
        <div class="mode-desc">å¡ç‰‡ç¿»è½¬<br>å¼ºåŒ–è®°å¿†</div>
      </div>
    </div>
  </div>
  <div id="recent-section" style="display:none">
    <div class="section-label">æœ€è¿‘è®°å½•</div>
    <div class="recent-list" id="recent-list"></div>
  </div>
</div>

<!-- â•â•â• CONFIG â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-config" class="screen slide-right">
  <div class="config-header">
    <button class="back-btn" onclick="showScreen('s-home')">â†</button>
    <div class="config-title">
      <h2 id="cfg-title">è®¾ç½®</h2>
    </div>
    <span class="mode-badge" id="cfg-badge"></span>
  </div>
  <div class="config-body" id="config-body">
    <!-- ç« èŠ‚ -->
    <div class="config-section">
      <div class="config-section-label">ç« èŠ‚ç­›é€‰</div>
      <div class="chip-wrap" id="unit-chips"></div>
    </div>
    <!-- é¢˜å‹ -->
    <div class="config-section">
      <div class="config-section-label">é¢˜å‹ç­›é€‰</div>
      <div class="chip-wrap" id="mode-chips"></div>
    </div>
    <!-- æ•°é‡ -->
    <div class="config-section">
      <div class="config-section-label">é¢˜ç›®æ•°é‡</div>
      <div class="count-row">
        <div class="count-val" id="count-display">50</div>
        <div class="slider-wrap">
          <input type="range" id="count-slider" min="5" max="200" value="50" step="5"
                 oninput="updateCount(this.value)">
        </div>
      </div>
    </div>
    <!-- è€ƒè¯•ä¸“å± -->
    <div id="exam-opts" style="display:none">
      <div class="config-section">
        <div class="config-section-label">è€ƒè¯•æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰</div>
        <div class="chip-wrap" id="time-chips">
          <button class="chip exam-chip" data-val="60" onclick="selectTime(this,60)">60åˆ†é’Ÿ</button>
          <button class="chip exam-chip active" data-val="90" onclick="selectTime(this,90)">90åˆ†é’Ÿ</button>
          <button class="chip exam-chip" data-val="120" onclick="selectTime(this,120)">120åˆ†é’Ÿ</button>
          <button class="chip exam-chip" data-val="150" onclick="selectTime(this,150)">150åˆ†é’Ÿ</button>
        </div>
      </div>
    </div>
    <!-- éšæœºé¡ºåº -->
    <div class="config-section">
      <div class="toggle-row">
        <div>
          <div>éšæœºé¡ºåº</div>
          <div class="desc">æ‰“ä¹±é¢˜ç›®æ’åˆ—</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="cfg-shuffle" checked>
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
      </div>
    </div>
  </div>
  <div class="config-footer">
    <button class="start-btn" id="start-btn" onclick="startSession()">å¼€å§‹ç»ƒä¹ </button>
  </div>
</div>

<!-- â•â•â• QUIZ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-quiz" class="screen slide-right">
  <div class="quiz-header">
    <button class="back-btn" onclick="quitQuiz()">âœ•</button>
    <div class="quiz-progress-wrap">
      <div class="quiz-progress-text">
        <span class="quiz-progress-cur"><span id="q-cur">1</span> / <span id="q-total">0</span></span>
        <span class="quiz-progress-total" id="q-unit-tag"></span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
    </div>
    <div class="quiz-timer" id="quiz-timer" style="display:none">â± <span id="timer-display">00:00</span></div>
    <button class="flag-btn" id="flag-btn" onclick="toggleFlag()" title="æ ‡è®°">âš‘</button>
  </div>
  <!-- Exam grid -->
  <div class="q-grid-panel" id="q-grid-panel">
    <div class="q-grid-inner" id="q-grid-inner"></div>
  </div>
  <div class="quiz-body">
    <div class="q-stage" id="q-stage">
      <div class="question-wrap" id="question-wrap">
        <!-- rendered by JS -->
      </div>
    </div>
  </div>
  <div class="quiz-footer" id="quiz-footer">
    <button class="nav-btn" id="btn-prev" onclick="prevQ()">â† ä¸Šé¢˜</button>
    <button class="nav-btn primary" id="btn-next" onclick="nextOrSubmit()">ä¸‹ä¸€é¢˜ â†’</button>
    <button class="q-grid-toggle" id="grid-toggle" onclick="toggleGrid()" style="display:none">é¢˜ç›®åˆ—è¡¨</button>
  </div>
</div>

<!-- â•â•â• MEMO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-memo" class="screen slide-right">
  <div class="quiz-header">
    <button class="back-btn" onclick="quitQuiz()">âœ•</button>
    <div class="quiz-progress-wrap">
      <div class="quiz-progress-text">
        <span class="quiz-progress-cur">ç¬¬ <span id="memo-cur">1</span> é¢˜</span>
        <span class="quiz-progress-total" id="memo-known-count"></span>
      </div>
      <div class="progress-bar"><div class="progress-fill memo-fill" id="memo-fill"></div></div>
    </div>
  </div>
  <div class="memo-body">
    <!-- è¿›åº¦ç»Ÿè®¡ -->
    <div class="memo-stats-row">
      <div class="memo-stat-item">
        <span class="memo-stat-dot known"></span>
        <span>å·²æŒæ¡ <span class="memo-stat-num" id="memo-known-num">0</span></span>
      </div>
      <div class="memo-stat-item">
        <span class="memo-stat-dot again-dot"></span>
        <span>å†ç»ƒ <span class="memo-stat-num" id="memo-again-num">0</span></span>
      </div>
      <div class="memo-stat-item">
        <span class="memo-stat-dot left"></span>
        <span>å‰©ä½™ <span class="memo-stat-num" id="memo-left-num">0</span></span>
      </div>
    </div>
    <!-- ä¸»å¡ç‰‡ -->
    <div class="memo-card-wrap" id="memo-card-wrap">
      <div class="memo-card" id="memo-card">
        <div class="memo-card-question" id="memo-question-area">
          <!-- rendered by JS -->
        </div>
        <div class="memo-card-answer" id="memo-answer-area">
          <!-- revealed by JS -->
        </div>
      </div>
    </div>
    <!-- æ­ç¤ºæŒ‰é’® -->
    <button class="memo-reveal-btn" id="memo-reveal-btn" onclick="memoReveal()">
      æŸ¥çœ‹ç­”æ¡ˆ â†“
    </button>
    <!-- è‡ªè¯„æŒ‰é’® -->
    <div class="memo-rate-row hidden" id="memo-rate-row">
      <button class="memo-rate-btn again" onclick="memoAgain()">â†º å†ç»ƒä¸€æ¬¡</button>
      <button class="memo-rate-btn know"  onclick="memoKnow()">âœ“ å·²æŒæ¡</button>
    </div>
  </div>
</div>

<!-- â•â•â• RESULTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-results" class="screen slide-right">
  <div class="results-header">
    <button class="back-btn" onclick="showScreen('s-home')">âœ•</button>
    <h2>æœ¬æ¬¡ç»“æœ</h2>
  </div>
  <div class="results-scroll">
    <div class="results-layout">
      <!-- å·¦æ ï¼šå¾—åˆ†å¡ -->
      <div class="score-card fade-up">
        <div class="score-card-top">
          <div class="score-ring-wrap">
            <svg class="score-ring" width="180" height="180" viewBox="0 0 180 180">
              <circle class="ring-bg"   cx="90" cy="90" r="80"/>
              <circle class="ring-fill" id="ring-fill" cx="90" cy="90" r="80"/>
            </svg>
            <div class="score-center">
              <div class="score-pct" id="score-pct">â€”</div>
              <div class="score-label">æ­£ç¡®ç‡</div>
            </div>
          </div>
          <div class="score-verdict" id="score-verdict"></div>
          <div class="score-sub"    id="score-sub"></div>
        </div>
        <div class="stats-grid">
          <div class="stat-cell">
            <div class="stat-cell-label">âœ… ç­”å¯¹</div>
            <div class="stat-cell-val ok" id="res-correct">â€”</div>
          </div>
          <div class="stat-cell">
            <div class="stat-cell-label">âŒ ç­”é”™</div>
            <div class="stat-cell-val err" id="res-wrong">â€”</div>
          </div>
          <div class="stat-cell">
            <div class="stat-cell-label">â­ æœªç­”</div>
            <div class="stat-cell-val warn" id="res-skip">â€”</div>
          </div>
          <div class="stat-cell">
            <div class="stat-cell-label">â± ç”¨æ—¶</div>
            <div class="stat-cell-val accent" id="res-time">â€”</div>
          </div>
        </div>
      </div>
      <!-- å³æ ï¼šç« èŠ‚åˆ†æ + æ“ä½œ -->
      <div class="results-right">
        <div class="unit-breakdown fade-up" id="unit-breakdown" style="display:none"></div>
        <div class="results-actions fade-up">
          <button class="res-btn primary" onclick="showReview()">ğŸ“– æŸ¥çœ‹è§£æ</button>
          <button class="res-btn ghost"   onclick="openConfig(S.mode)">ğŸ” å†ç»ƒä¸€æ¬¡</button>
          <button class="res-btn ghost"   onclick="showScreen('s-home')">ğŸ  å›åˆ°ä¸»é¡µ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• REVIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="s-review" class="screen slide-right">
  <div class="review-header">
    <button class="back-btn" onclick="showScreen('s-results')">â†</button>
    <h2>é¢˜ç›®è§£æ</h2>
  </div>
  <div class="review-tabs">
    <button class="rtab active"    onclick="filterReview('all',this)">å…¨éƒ¨</button>
    <button class="rtab wrong-tab" onclick="filterReview('wrong',this)">ç­”é”™</button>
    <button class="rtab ok-tab"    onclick="filterReview('ok',this)">ç­”å¯¹</button>
    <button class="rtab"           onclick="filterReview('skip',this)">æœªç­”</button>
  </div>
  <div class="review-list" id="review-list"></div>
</div>

<div id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// çŠ¶æ€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  mode: 'practice',
  questions: [],
  cur: 0,
  ans: {},          // idx -> letter
  marked: new Set(),
  revealed: new Set(),
  memoQueue: [],
  memoKnown: new Set(),
  memoCur: 0,
  memoFlipped: false,
  examStart: null,
  examLimit: 90 * 60,
  timerInterval: null,
  bankInfo: null,
  results: null,
  history: [],      // stored in localStorage
};

const CFG = {
  units: new Set(['__all__']),
  modes: new Set(['__all__']),
  count: 50,
  shuffle: true,
  examTime: 90,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  loadTheme();
  loadHistory();
  try {
    S.bankInfo = await fetch('/api/info').then(r => r.json());
    renderHome();
  } catch(e) {
    document.getElementById('home-bank-name').textContent = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨';
  }
}

function renderHome() {
  const info = S.bankInfo;
  document.getElementById('home-bank-name').textContent = info.bank_name || 'é¢˜åº“';
  document.getElementById('stat-sq').textContent    = info.total_sq.toLocaleString();
  document.getElementById('stat-units').textContent = info.units.length;
  document.getElementById('stat-modes').textContent = info.modes.length;
  renderHistorySection();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Screen transitions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id, dir = 'forward') {
  const cur = document.querySelector('.screen.active');
  const next = document.getElementById(id);
  if (!next || next === cur) return;

  if (cur) {
    cur.classList.remove('active');
    cur.classList.add(dir === 'forward' ? 'slide-left' : 'slide-right');
    setTimeout(() => cur.classList.remove('slide-left','slide-right'), 250);
  }
  next.classList.remove('slide-left','slide-right');
  next.classList.add('active');
  // force reflow then re-add to trigger transition
  next.offsetHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config screen
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openConfig(mode) {
  S.mode = mode;
  const titles = { practice:'ç»ƒä¹ æ¨¡å¼', exam:'è€ƒè¯•æ¨¡å¼', memo:'èƒŒé¢˜æ¨¡å¼' };
  document.getElementById('cfg-title').textContent = titles[mode];
  const badge = document.getElementById('cfg-badge');
  badge.textContent = titles[mode];
  badge.className = `mode-badge ${mode}`;

  const startBtn = document.getElementById('start-btn');
  const examLabel = { practice:'å¼€å§‹ç»ƒä¹ ', exam:'å¼€å§‹è€ƒè¯•', memo:'å¼€å§‹èƒŒé¢˜' };
  startBtn.textContent = examLabel[mode];
  startBtn.className = `start-btn ${mode}-start`;

  document.getElementById('exam-opts').style.display = mode === 'exam' ? '' : 'none';

  // Chips
  buildChips('unit-chips', S.bankInfo.units, 'unit', mode);
  buildChips('mode-chips', S.bankInfo.modes, 'mode', mode);

  CFG.units = new Set(['__all__']);
  CFG.modes = new Set(['__all__']);

  const maxQ = S.bankInfo.total_sq;
  const slider = document.getElementById('count-slider');
  slider.max = Math.min(maxQ, 300);
  slider.value = Math.min(CFG.count, Number(slider.max));
  updateCount(slider.value);

  showScreen('s-config');
}

function buildChips(containerId, items, type, mode) {
  const wrap = document.getElementById(containerId);
  wrap.innerHTML = '';
  const all = document.createElement('button');
  all.className = 'chip active';
  all.textContent = 'å…¨éƒ¨';
  all.dataset.val = '__all__';
  all.onclick = () => toggleChip(all, type, mode);
  wrap.appendChild(all);
  items.forEach(item => {
    const btn = document.createElement('button');
    btn.className = `chip`;
    btn.textContent = item;
    btn.dataset.val = item;
    btn.onclick = () => toggleChip(btn, type, mode);
    wrap.appendChild(btn);
  });
}

function toggleChip(btn, type, mode) {
  const val = btn.dataset.val;
  const set = type === 'unit' ? CFG.units : CFG.modes;
  const container = type === 'unit' ? 'unit-chips' : 'mode-chips';
  const chips = document.querySelectorAll(`#${container} .chip`);

  if (val === '__all__') {
    set.clear(); set.add('__all__');
    chips.forEach(c => c.classList.toggle('active', c.dataset.val === '__all__'));
  } else {
    set.delete('__all__');
    if (set.has(val)) { set.delete(val); btn.classList.remove('active'); }
    else              { set.add(val);    btn.classList.add('active'); }
    if (set.size === 0) { set.add('__all__'); chips.forEach(c => c.classList.toggle('active', c.dataset.val === '__all__')); }
    else { chips.forEach(c => c.classList.toggle('active', c.dataset.val !== '__all__' && set.has(c.dataset.val))); document.querySelector(`#${container} .chip[data-val="__all__"]`).classList.remove('active'); }
  }
}

function selectTime(btn, val) {
  CFG.examTime = val;
  document.querySelectorAll('#time-chips .chip').forEach(c => c.classList.toggle('active', Number(c.dataset.val) === val));
}

function updateCount(v) {
  CFG.count = Number(v);
  const display = document.getElementById('count-display');
  display.textContent = v >= Number(document.getElementById('count-slider').max) ? 'å…¨éƒ¨' : v;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Start session
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startSession() {
  const params = new URLSearchParams();
  if (!CFG.units.has('__all__')) CFG.units.forEach(u => params.append('unit', u));
  if (!CFG.modes.has('__all__')) CFG.modes.forEach(m => params.append('mode', m));
  params.set('shuffle', document.getElementById('cfg-shuffle').checked ? '1' : '0');

  const maxSlider = Number(document.getElementById('count-slider').max);
  if (CFG.count < maxSlider) params.set('limit', CFG.count);

  const data = await fetch('/api/questions?' + params).then(r => r.json());
  if (!data.items.length) { toast('æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®'); return; }

  S.questions = data.items;
  S.cur = 0;
  S.ans = {};
  S.marked = new Set();
  S.revealed = new Set();
  S.examStart = Date.now();

  if (S.mode === 'memo') startMemo();
  else                   startQuiz();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ (practice + exam)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startQuiz() {
  const isExam = S.mode === 'exam';
  clearInterval(S.timerInterval);

  const timer = document.getElementById('quiz-timer');
  const gridToggle = document.getElementById('grid-toggle');
  const fill = document.getElementById('progress-fill');

  if (isExam) {
    S.examLimit = CFG.examTime * 60;
    timer.style.display = '';
    timer.classList.remove('urgent');
    gridToggle.style.display = '';
    fill.className = 'progress-fill exam-fill';
    startTimer(S.examLimit);
    buildGrid();
  } else {
    timer.style.display = 'none';
    gridToggle.style.display = 'none';
    fill.className = 'progress-fill';
    document.getElementById('q-grid-panel').classList.remove('open');
  }

  showScreen('s-quiz');
  renderQ('none');
}

// â”€â”€â”€ é€šç”¨æ»‘åŠ¨åˆ‡é¢˜åŠ©æ‰‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// dir: 'forward'(â†’) | 'back'(â†) | 'none'(æ— åŠ¨ç”»ï¼Œåˆæ¬¡æ¸²æŸ“)
function _slideQ(dir, buildFn) {
  const body     = document.querySelector('.quiz-body');
  const oldStage = body.querySelector('.q-stage');

  // æ–° stage
  const newStage = document.createElement('div');
  newStage.className = 'q-stage';
  const wrap = document.createElement('div');
  wrap.className = 'question-wrap';
  wrap.id = 'question-wrap';
  newStage.appendChild(wrap);
  buildFn(wrap);  // å‘ wrap å†…å¡«å……é¢˜ç›®å†…å®¹

  if (!oldStage || dir === 'none') {
    body.innerHTML = '';
    body.appendChild(newStage);
    return;
  }

  // åŒæ—¶æŒ‚åˆ° bodyï¼ˆç»å¯¹å®šä½å åœ¨ä¸€èµ·ï¼‰
  body.appendChild(newStage);

  // æ—§çš„æ»‘å‡ºï¼Œæ–°çš„æ»‘å…¥
  const exitCls  = dir === 'forward' ? 'exit-left'   : 'exit-right';
  const enterCls = dir === 'forward' ? 'enter-right'  : 'enter-left';
  oldStage.classList.add(exitCls);
  newStage.classList.add(enterCls);

  // åŠ¨ç”»ç»“æŸåæ¸…ç†
  const DUR = 230;
  setTimeout(() => {
    oldStage.remove();
    newStage.classList.remove(enterCls);
    // æ–° stage æ‹¿åˆ°æ­£å¸¸å®šä½
    newStage.style.position = '';
  }, DUR);
}

function renderQ(dir = 'none') {
  const q       = S.questions[S.cur];
  const total   = S.questions.length;
  const isExam  = S.mode === 'exam';
  const isPractice = S.mode === 'practice';

  if (!q) { toast('é¢˜ç›®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•'); return; }

  // â”€â”€ æ›´æ–° Headerï¼ˆä¸éšå¡ç‰‡åŠ¨ç”»ï¼Œå³æ—¶æ›´æ–°ï¼‰â”€â”€
  document.getElementById('q-cur').textContent = S.cur + 1;
  document.getElementById('q-total').textContent = total;
  document.getElementById('q-unit-tag').textContent = q.unit || '';
  document.getElementById('progress-fill').style.width = ((S.cur + 1) / total * 100).toFixed(1) + '%';
  document.getElementById('flag-btn').classList.toggle('active', S.marked.has(S.cur));

  // â”€â”€ Footer æŒ‰é’® â”€â”€
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  btnPrev.disabled = S.cur === 0;
  if (isExam) {
    btnNext.textContent = S.cur === total - 1 ? 'äº¤å· âœ“' : 'ä¸‹ä¸€é¢˜ â†’';
    btnNext.className = 'nav-btn primary exam';
    btnNext.disabled  = false;
  } else {
    const isRevealed = S.revealed.has(S.cur);
    btnNext.textContent = S.cur === total - 1 ? 'å®Œæˆ âœ“' : 'ä¸‹ä¸€é¢˜ â†’';
    btnNext.className = 'nav-btn primary';
    btnNext.disabled  = !isRevealed;
  }

  // â”€â”€ æ»‘åŠ¨åˆ‡æ¢ï¼Œå®é™…æ¸²æŸ“åœ¨å›è°ƒé‡Œ â”€â”€
  _slideQ(dir, wrap => _fillQ(wrap, q, isExam, isPractice));
}

function _fillQ(wrap, q, isExam, isPractice) {
  const isMulti    = q.answer && q.answer.length > 1;
  const correctSet = new Set(isMulti ? q.answer.split('') : [q.answer]);
  const curSel     = S.ans[S.cur];
  const isRevealed = S.revealed.has(S.cur);

  // Tags
  const tags = document.createElement('div');
  tags.className = 'q-tags';
  if (q.mode) tags.innerHTML += `<span class="q-tag mode-tag">${esc(q.mode)}</span>`;
  if (q.unit) tags.innerHTML += `<span class="q-tag unit-tag">${esc(q.unit)}</span>`;
  if (q.rate != null) {
    let rateVal = q.rate;
    if (typeof rateVal === 'string') rateVal = parseFloat(rateVal.replace('%','')) || 0;
    const rateClass = rateVal >= 70 ? 'easy' : '';
    tags.innerHTML += `<span class="q-tag rate-tag ${rateClass}">æ­£ç¡®ç‡ ${rateVal.toFixed(0)}%</span>`;
  }
  wrap.appendChild(tags);

  // Stem
  if (q.stem) {
    const siblingCount = S.questions.filter(sq => sq.qi === q.qi).length;
    const label = siblingCount > 1
      ? `å…±ç”¨é¢˜å¹²ï¼ˆå…± ${siblingCount} å°é¢˜ Â· ç¬¬ ${q.si + 1} é¢˜ï¼‰`
      : 'å…±ç”¨é¢˜å¹²';
    const stemDiv = document.createElement('div');
    stemDiv.className = 'q-stem q-stem-collapsible';
    stemDiv.innerHTML = `
      <div class="q-stem-label">${label}<span class="stem-toggle-hint">â–´ ç‚¹å‡»æ”¶èµ·</span></div>
      <div class="q-stem-content">${esc(q.stem)}</div>`;
    stemDiv.querySelector('.q-stem-label').addEventListener('click', () => {
      const c = stemDiv.classList.toggle('is-collapsed');
      stemDiv.querySelector('.stem-toggle-hint').textContent = c ? 'â–¾ ç‚¹å‡»å±•å¼€' : 'â–´ ç‚¹å‡»æ”¶èµ·';
    });
    wrap.appendChild(stemDiv);
  }

  // Question text
  const qtxt = document.createElement('div');
  qtxt.className = 'q-text';
  const qContent = q.text || (q.options?.length ? 'ï¼ˆè¯·æŸ¥çœ‹ä¸‹æ–¹é€‰é¡¹ï¼‰' : 'é¢˜ç›®å†…å®¹ä¸ºç©º');
  qtxt.innerHTML = `<span class="q-num">${S.cur + 1}</span>${esc(qContent)}`;
  wrap.appendChild(qtxt);

  // Multi badge
  if (isMulti) {
    const badge = document.createElement('div');
    badge.className = 'multi-badge';
    badge.innerHTML = 'âŠ å¤šé€‰é¢˜';
    wrap.appendChild(badge);
  }

  // Options
  const opts = document.createElement('div');
  opts.className = 'options-list';
  q.options.forEach((opt, i) => {
    const letter = String.fromCharCode(65 + i);
    const btn = document.createElement('button');
    btn.className = 'opt';
    if (isRevealed) {
      const inCorrect = correctSet.has(letter);
      const wasSelected = isMulti
        ? (curSel instanceof Set ? curSel.has(letter) : false)
        : curSel === letter;
      if (inCorrect) btn.classList.add('correct');
      else if (wasSelected) btn.classList.add('wrong');
      else btn.classList.add('dim');
      btn.disabled = true;
    } else if (isExam) {
      const sel = isMulti ? (curSel instanceof Set && curSel.has(letter)) : curSel === letter;
      if (sel) btn.classList.add(isMulti ? 'multi-selected' : 'selected');
      btn.onclick = () => selectOpt(letter, btn);
    } else {
      const sel = isMulti ? (curSel instanceof Set && curSel.has(letter)) : curSel === letter;
      if (sel) btn.classList.add(isMulti ? 'multi-selected' : 'selected');
      btn.onclick = () => selectOpt(letter, btn);
    }
    btn.innerHTML = `<span class="opt-label">${letter}</span><span class="opt-text">${esc(opt)}</span>`;
    opts.appendChild(btn);
  });
  wrap.appendChild(opts);

  // å¤šé€‰ç¡®è®¤æŒ‰é’®
  if (isMulti && !isRevealed) {
    const cfm = document.createElement('button');
    cfm.className = 'confirm-btn' + (isExam ? ' exam' : '');
    cfm.textContent = isExam ? 'ç¡®è®¤é€‰æ‹©' : 'æäº¤ç­”æ¡ˆ';
    cfm.disabled = !(curSel instanceof Set && curSel.size > 0);
    cfm.onclick = () => submitMulti();
    wrap.appendChild(cfm);
  }

  // Explanation
  if (isPractice && isRevealed) {
    wrap.appendChild(buildExplain(q, curSel));
  } else if (isPractice) {
    const p = document.createElement('div');
    p.className = 'explain-panel';
    p.id = 'explain-panel';
    wrap.appendChild(p);
  }
}


function selectOpt(letter, btn) {
  const q = S.questions[S.cur];
  const isExam    = S.mode === 'exam';
  const isPractice= S.mode === 'practice';
  const isMulti   = q.answer && q.answer.length > 1;

  if (isMulti) {
    // â”€â”€ å¤šé€‰ï¼štoggle å½“å‰é¡¹ï¼Œæ›´æ–°è§†è§‰ï¼Œæ¿€æ´»ç¡®è®¤æŒ‰é’® â”€â”€
    if (!S.ans[S.cur] || !(S.ans[S.cur] instanceof Set)) {
      S.ans[S.cur] = new Set();
    }
    const sel = S.ans[S.cur];
    if (sel.has(letter)) {
      sel.delete(letter);
      btn.classList.remove('multi-selected');
      btn.querySelector('.opt-label').style.background = '';
      btn.querySelector('.opt-label').style.color = '';
    } else {
      sel.add(letter);
      btn.classList.add('multi-selected');
    }
    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    const cfm = document.querySelector('.confirm-btn');
    if (cfm) cfm.disabled = sel.size === 0;

  } else {
    // â”€â”€ å•é€‰ â”€â”€
    S.ans[S.cur] = letter;

    if (isExam) {
      // è€ƒè¯•ï¼šæ ‡è®°å·²é€‰ï¼Œè‡ªåŠ¨è·³ä¸‹ä¸€é¢˜
      document.querySelectorAll('.opt').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      const dot = document.querySelector(`.q-dot[data-idx="${S.cur}"]`);
      if (dot) { dot.classList.add('answered'); }
      // è‡ªåŠ¨å‰è¿›ï¼ˆçŸ­æš‚å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°é€‰ä¸­æ€ï¼‰
      setTimeout(() => {
        const total = S.questions.length;
        if (S.cur < total - 1) { S.cur++; renderQ('forward'); updateGridDot(); }
        else { document.getElementById('btn-next').textContent = 'äº¤å· âœ“'; document.getElementById('btn-next').disabled = false; }
      }, 250);

    } else {
      // ç»ƒä¹ ï¼šç«‹å³æ­ç¤ºç­”æ¡ˆ
      document.querySelectorAll('.opt').forEach(b => b.disabled = true);
      S.revealed.add(S.cur);
      const isCorrect = letter === q.answer;
      setTimeout(() => {
        renderQ('none');  // æ­ç¤ºç­”æ¡ˆåŸåœ°é‡æ¸²ï¼Œä¸æ»‘åŠ¨
        // ç­”å¯¹åˆ™ 1.4s åè‡ªåŠ¨è·³ä¸‹ä¸€é¢˜ï¼Œç­”é”™ä¸è‡ªåŠ¨è·³
        if (isCorrect) {
          setTimeout(() => {
            const explain = document.getElementById('explain-panel');
            if (explain) explain.scrollIntoView({ behavior:'smooth', block:'nearest' });
            setTimeout(() => {
              const total = S.questions.length;
              if (S.cur < total - 1) { S.cur++; renderQ('forward'); }
              else finishPractice();
            }, 1400);
          }, 100);
        } else {
          setTimeout(() => {
            const explain = document.getElementById('explain-panel');
            if (explain) explain.scrollIntoView({ behavior:'smooth', block:'nearest' });
          }, 100);
          document.getElementById('btn-next').disabled = false;
        }
      }, 180);
    }
  }
}

// å¤šé€‰æäº¤ï¼ˆç»ƒä¹  + è€ƒè¯•å…±ç”¨ï¼‰
function submitMulti() {
  const q        = S.questions[S.cur];
  const isExam   = S.mode === 'exam';
  const isPractice = S.mode === 'practice';
  const sel      = S.ans[S.cur]; // Set<string>
  if (!sel || sel.size === 0) return;

  if (isExam) {
    // è€ƒè¯•æ¨¡å¼ï¼šæ ‡è®°å·²ç­”ï¼Œæ›´æ–°å°åœ°å›¾ï¼Œç›´æ¥è·³ä¸‹ä¸€é¢˜
    const dot = document.querySelector(`.q-dot[data-idx="${S.cur}"]`);
    if (dot) dot.classList.add('answered');
    setTimeout(() => {
      const total = S.questions.length;
      if (S.cur < total - 1) { S.cur++; renderQ('forward'); updateGridDot(); }
      else { document.getElementById('btn-next').textContent = 'äº¤å· âœ“'; document.getElementById('btn-next').disabled = false; }
    }, 120);

  } else {
    // ç»ƒä¹ æ¨¡å¼ï¼šæ­ç¤ºç­”æ¡ˆï¼ŒåŸåœ°é‡æ¸²
    S.revealed.add(S.cur);
    setTimeout(() => {
      renderQ('none');
      setTimeout(() => {
        const explain = document.getElementById('explain-panel');
        if (explain) explain.scrollIntoView({ behavior:'smooth', block:'nearest' });
      }, 100);
      // æ­ç¤ºåä¸è‡ªåŠ¨è·³ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹ä¸‹ä¸€é¢˜
      document.getElementById('btn-next').disabled = false;
    }, 180);
  }
}

function buildExplain(q, selected) {
  const isMulti   = q.answer && q.answer.length > 1;
  const correctSet= new Set(isMulti ? q.answer.split('') : [q.answer]);
  // åˆ¤æ–­æ˜¯å¦å®Œå…¨æ­£ç¡®
  let isCorrect;
  if (isMulti) {
    const selSet = selected instanceof Set ? selected : new Set();
    isCorrect = selSet.size === correctSet.size &&
      [...correctSet].every(l => selSet.has(l));
  } else {
    isCorrect = selected === q.answer;
  }

  const panel = document.createElement('div');
  panel.className = 'explain-panel open';
  panel.id = 'explain-panel';

  const inner = document.createElement('div');
  inner.className = 'explain-inner';

  const resultRow = document.createElement('div');
  resultRow.className = `explain-result ${isCorrect ? 'ok' : 'err'}`;
  resultRow.innerHTML = `
    <span class="result-icon">${isCorrect ? 'âœ…' : 'âŒ'}</span>
    <span class="result-title ${isCorrect ? 'ok' : 'err'}">${isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : (isMulti ? 'ç­”æ¡ˆä¸å®Œæ•´æˆ–æœ‰è¯¯' : 'å›ç­”é”™è¯¯')}</span>`;
  inner.appendChild(resultRow);

  if (!isCorrect) {
    const corrRow = document.createElement('div');
    corrRow.className = 'explain-correct-row';
    if (isMulti) {
      corrRow.innerHTML = `æ­£ç¡®ç­”æ¡ˆï¼š<span class="multi-ans">${q.answer.split('').join(' ')}</span>`;
    } else {
      corrRow.innerHTML = `æ­£ç¡®ç­”æ¡ˆï¼š<span>${q.answer}</span>`;
    }
    inner.appendChild(corrRow);
  }

  const body = document.createElement('div');
  body.className = 'explain-body';
  if (q.discuss) {
    body.textContent = q.discuss;
    if (q.point) body.innerHTML += `<div class="explain-point"><span>è€ƒç‚¹ï¼š</span>${esc(q.point)}</div>`;
  } else {
    body.innerHTML = '<span style="color:var(--muted)">æš‚æ— è§£æ</span>';
  }
  inner.appendChild(body);
  panel.appendChild(inner);
  return panel;
}

function nextOrSubmit() {
  const total = S.questions.length;
  if (S.mode === 'exam' && S.cur === total - 1) { submitExam(); return; }
  if (S.mode === 'practice' && S.cur === total - 1) { finishPractice(); return; }
  S.cur++;
  renderQ('forward');
  if (S.mode === 'exam') updateGridDot();
}

function prevQ() {
  if (S.cur > 0) {
    S.cur--;
    renderQ('back');
    if (S.mode === 'exam') updateGridDot();
  }
}

function toggleFlag() {
  if (S.marked.has(S.cur)) S.marked.delete(S.cur); else S.marked.add(S.cur);
  document.getElementById('flag-btn').classList.toggle('active', S.marked.has(S.cur));
  updateGridDot();
}

function quitQuiz() {
  clearInterval(S.timerInterval);
  if (S.mode === 'exam') {
    if (!confirm('ç¡®è®¤é€€å‡ºè€ƒè¯•ï¼Ÿæœ¬æ¬¡è®°å½•ä¸ä¼šä¿å­˜')) return;
  }
  showScreen('s-home', 'back');
}

// â”€â”€ Exam timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTimer(seconds) {
  let rem = seconds;
  updateTimerDisp(rem);
  S.timerInterval = setInterval(() => {
    rem--;
    updateTimerDisp(rem);
    if (rem <= 0) { clearInterval(S.timerInterval); submitExam(); }
  }, 1000);
}
function updateTimerDisp(sec) {
  const m = String(Math.floor(sec / 60)).padStart(2,'0');
  const s = String(sec % 60).padStart(2,'0');
  document.getElementById('timer-display').textContent = `${m}:${s}`;
  if (sec < 300) document.getElementById('quiz-timer').classList.add('urgent');
}

// â”€â”€ Exam grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGrid() {
  const inner = document.getElementById('q-grid-inner');
  inner.innerHTML = '';
  S.questions.forEach((_, i) => {
    const dot = document.createElement('div');
    dot.className = `q-dot${i === 0 ? ' cur' : ''}`;
    dot.dataset.idx = i;
    dot.textContent = i + 1;
    dot.onclick = () => {
      const dir = i > S.cur ? 'forward' : i < S.cur ? 'back' : 'none';
      S.cur = i;
      renderQ(dir);
      updateGridDot();
    };
    inner.appendChild(dot);
  });
}
function updateGridDot() {
  document.querySelectorAll('.q-dot').forEach((dot, i) => {
    const sel = S.ans[i];
    const hasAns = sel !== undefined && !(sel instanceof Set && sel.size === 0);
    dot.classList.toggle('cur',      i === S.cur);
    dot.classList.toggle('answered', hasAns && i !== S.cur);
    dot.classList.toggle('flagged',  S.marked.has(i) && i !== S.cur);
  });
}
function toggleGrid() {
  document.getElementById('q-grid-panel').classList.toggle('open');
}

// â”€â”€ Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitExam() {
  clearInterval(S.timerInterval);
  calculateResults();
  showScreen('s-results');
}
function finishPractice() {
  calculateResults();
  showScreen('s-results');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MEMO mode
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startMemo() {
  S.memoQueue   = [...Array(S.questions.length).keys()];
  S.memoKnown   = new Set();
  S.memoAgainSet= new Set();  // æœ¬è½®æ ‡è®°"å†ç»ƒ"çš„
  S.memoCur     = 0;
  S.memoRevealed= false;
  showScreen('s-memo');
  renderMemo('none');
}

function renderMemo(dir = 'forward') {
  const total   = S.questions.length;
  const known   = S.memoKnown.size;
  const again   = S.memoAgainSet.size;
  const left    = S.memoQueue.length - S.memoCur;

  // è¿›åº¦
  document.getElementById('memo-cur').textContent = S.memoCur + 1;
  document.getElementById('memo-fill').style.width = (known / total * 100) + '%';
  document.getElementById('memo-known-count').textContent = `å·²æŒæ¡ ${known} / ${total}`;
  document.getElementById('memo-known-num').textContent = known;
  document.getElementById('memo-again-num').textContent = again;
  document.getElementById('memo-left-num').textContent  = Math.max(0, left);

  if (S.memoCur >= S.memoQueue.length) { showMemoResults(); return; }

  const qi = S.memoQueue[S.memoCur];
  const q  = S.questions[qi];

  // é‡ç½®æŒ‰é’®çŠ¶æ€
  S.memoRevealed = false;
  document.getElementById('memo-reveal-btn').classList.remove('hidden');
  document.getElementById('memo-rate-row').classList.add('hidden');

  // æ„å»ºæ–°å¡ç‰‡å†…å®¹
  const answerSet = new Set(q.answer.length > 1 ? q.answer.split('') : [q.answer]);
  const metaTags = `<div class="memo-card-meta">
    ${q.mode ? `<span class="q-tag mode-tag">${esc(q.mode)}</span>` : ''}
    ${q.unit ? `<span class="q-tag unit-tag">${esc(q.unit)}</span>` : ''}
    ${q.answer.length > 1 ? `<span class="multi-badge">âŠ å¤šé€‰</span>` : ''}
  </div>`;
  const stemHtml = q.stem ? `<div class="memo-stem-block">${esc(q.stem)}</div>` : '';
  const optsHtml = q.options.map((o, i) => {
    const l = String.fromCharCode(65 + i);
    return `<div class="memo-opt" id="mopt-${l}">
      <span class="memo-opt-label">${l}</span><span>${esc(o)}</span>
    </div>`;
  }).join('');
  const explainHtml = q.discuss
    ? `<div class="memo-explain-text">${esc(q.discuss)}</div>
       ${q.point ? `<div class="memo-explain-point">è€ƒç‚¹ï¼š${esc(q.point)}</div>` : ''}`
    : `<div class="memo-explain-text" style="color:var(--muted)">æš‚æ— è§£æ</div>`;

  const questionHtml = metaTags + stemHtml +
    `<div class="memo-q-text">${esc(q.text)}</div>
     <div class="memo-opts">${optsHtml}</div>`;
  const answerHtml = `<div class="memo-answer-inner">
     <div class="memo-answer-label">æ­£ç¡®ç­”æ¡ˆ</div>
     ${explainHtml}
   </div>`;

  // â”€â”€ æ»‘åŠ¨åŠ¨ç”» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wrap   = document.getElementById('memo-card-wrap');
  const oldCard = document.getElementById('memo-card');
  const DUR = 210;

  if (!oldCard || dir === 'none') {
    // åˆæ¬¡æ¸²æŸ“ï¼Œæ— åŠ¨ç”»
    if (oldCard) {
      document.getElementById('memo-question-area').innerHTML = questionHtml;
      document.getElementById('memo-answer-area').innerHTML  = answerHtml;
      document.getElementById('memo-answer-area').classList.remove('revealed');
    }
    return;
  }

  // æ–°å¡ç‰‡
  const newCard = document.createElement('div');
  newCard.className = 'memo-card';
  newCard.id = 'memo-card';
  newCard.innerHTML = `
    <div class="memo-card-question" id="memo-question-area">${questionHtml}</div>
    <div class="memo-card-answer" id="memo-answer-area">${answerHtml}</div>`;

  // è®© wrap æœ‰å›ºå®šé«˜åº¦å®¹çº³ä¸¤å¼ ç‰Œå æ”¾
  const h = oldCard.offsetHeight;
  wrap.style.height = h + 'px';
  wrap.style.overflow = 'hidden';

  // æ—§å¡ç‰‡ç»å¯¹å®šä½æ’‘æ»¡ wrap
  oldCard.style.position = 'absolute';
  oldCard.style.inset = '0';
  oldCard.removeAttribute('id'); // é¿å… id å†²çª

  // æ–°å¡ç‰‡ç»å¯¹å®šä½
  newCard.style.position = 'absolute';
  newCard.style.inset = '0';
  wrap.appendChild(newCard);

  // åŠ¨ç”»ç±»
  const exitCls  = dir === 'forward' ? 'memo-exit-left'  : 'memo-exit-right';
  const enterCls = dir === 'forward' ? 'memo-enter-right' : 'memo-enter-left';
  oldCard.classList.add(exitCls);
  newCard.classList.add(enterCls);

  setTimeout(() => {
    oldCard.remove();
    newCard.classList.remove(enterCls);
    // æ¢å¤æ­£å¸¸æµå¸ƒå±€
    newCard.style.position = '';
    newCard.style.inset = '';
    wrap.style.height = '';
    wrap.style.overflow = '';
    // æ»šåŠ¨åˆ°é¡¶
    document.querySelector('.memo-body').scrollTop = 0;
  }, DUR);
}

function memoReveal() {
  if (S.memoRevealed) return;
  S.memoRevealed = true;

  const qi = S.memoQueue[S.memoCur];
  const q  = S.questions[qi];
  const answerSet = new Set(q.answer.length > 1 ? q.answer.split('') : [q.answer]);

  // é«˜äº®æ­£ç¡®é€‰é¡¹
  q.options.forEach((_, i) => {
    const l = String.fromCharCode(65 + i);
    const optEl = document.getElementById(`mopt-${l}`);
    if (optEl && answerSet.has(l)) {
      optEl.classList.add('is-answer');
    }
  });

  // å±•å¼€ç­”æ¡ˆåŒº
  document.getElementById('memo-answer-area').classList.add('revealed');
  document.getElementById('memo-reveal-btn').classList.add('hidden');
  document.getElementById('memo-rate-row').classList.remove('hidden');

  // æ»šåŠ¨æ˜¾ç¤ºç­”æ¡ˆ
  setTimeout(() => {
    document.getElementById('memo-answer-area').scrollIntoView({ behavior:'smooth', block:'nearest' });
  }, 200);
}

function memoKnow() {
  const qi = S.memoQueue[S.memoCur];
  S.memoKnown.add(qi);
  S.memoAgainSet.delete(qi);
  S.memoCur++;
  renderMemo('forward');
}

function memoAgain() {
  const qi = S.memoQueue[S.memoCur];
  S.memoAgainSet.add(qi);
  S.memoCur++;
  if (S.memoCur >= S.memoQueue.length) {
    const unknown = S.memoQueue.filter(qi => !S.memoKnown.has(qi));
    if (unknown.length === 0) { showMemoResults(); return; }
    S.memoQueue = unknown;
    S.memoCur   = 0;
    S.memoAgainSet.clear();
    toast(`è¿˜æœ‰ ${unknown.length} é¢˜ï¼Œå†æ¥ä¸€é ğŸ’ª`);
  }
  renderMemo('forward');
}

function showMemoResults() {
  const total = S.questions.length;
  const known = S.memoKnown.size;
  S.results = { mode:'memo', total, correct: known, wrong: total - known, skip: 0,
                timeSec: Math.floor((Date.now() - S.examStart) / 1000) };
  showScreen('s-results');
  renderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Results
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calculateResults() {
  const qs = S.questions;
  let correct = 0, wrong = 0, skip = 0;
  const byUnit = {};

  qs.forEach((q, i) => {
    const sel  = S.ans[i];
    const unit = q.unit || 'å…¶ä»–';
    if (!byUnit[unit]) byUnit[unit] = { correct: 0, total: 0 };
    byUnit[unit].total++;

    const isMulti = q.answer && q.answer.length > 1;
    let isCorrect = false;
    if (!sel || (sel instanceof Set && sel.size === 0)) {
      skip++;
      return;
    }
    if (isMulti) {
      const correctSet = new Set(q.answer.split(''));
      const selSet = sel instanceof Set ? sel : new Set([sel]);
      isCorrect = selSet.size === correctSet.size && [...correctSet].every(l => selSet.has(l));
    } else {
      isCorrect = sel === q.answer;
    }
    if (isCorrect) { correct++; byUnit[unit].correct++; }
    else wrong++;
  });

  S.results = {
    mode: S.mode,
    total: qs.length, correct, wrong, skip,
    timeSec: Math.floor((Date.now() - S.examStart) / 1000),
    byUnit,
    qs, ans: { ...S.ans },
  };

  // Save to history
  const record = {
    mode: S.mode, total: qs.length, correct,
    pct: Math.round(correct / qs.length * 100),
    timeSec: S.results.timeSec,
    date: new Date().toLocaleDateString('zh-CN'),
    units: [...new Set(qs.map(q => q.unit).filter(Boolean))].slice(0,2).join('ã€'),
  };
  S.history.unshift(record);
  S.history = S.history.slice(0, 10);
  localStorage.setItem('quiz-history', JSON.stringify(S.history));

  renderResults();
}

function renderResults() {
  const R = S.results;
  const pct = Math.round(R.correct / R.total * 100);
  const pass = pct >= 60;

  document.getElementById('score-pct').textContent = pct + '%';
  document.getElementById('score-verdict').textContent = pass ? 'ğŸ‰ é€šè¿‡ï¼' : 'ç»§ç»­åŠªåŠ›';
  document.getElementById('score-sub').textContent =
    `ç­”å¯¹ ${R.correct} é¢˜ï¼Œå…± ${R.total} é¢˜`;

  // Ringï¼ˆr=80ï¼‰
  const circumference = 2 * Math.PI * 80; // 502.65
  const ring = document.getElementById('ring-fill');
  ring.style.strokeDasharray = circumference;
  ring.style.strokeDashoffset = circumference;
  ring.className = `ring-fill ${pct >= 60 ? 'pass' : 'fail'}`;
  setTimeout(() => {
    ring.style.strokeDashoffset = circumference * (1 - pct / 100);
  }, 120);

  document.getElementById('res-correct').textContent = R.correct;
  document.getElementById('res-wrong').textContent   = R.wrong;
  document.getElementById('res-skip').textContent    = R.skip;
  document.getElementById('res-time').textContent    = formatTime(R.timeSec);

  // Unit breakdown
  const bk = document.getElementById('unit-breakdown');
  if (R.byUnit && Object.keys(R.byUnit).length > 1) {
    const entries = Object.entries(R.byUnit).sort((a,b) => b[1].total - a[1].total).slice(0, 8);
    bk.innerHTML = '<h3>ç« èŠ‚åˆ†æ</h3>' + entries.map(([unit, d]) => {
      const p = Math.round(d.correct / d.total * 100);
      const color = p >= 60 ? 'var(--success)' : 'var(--danger)';
      return `<div class="unit-row">
        <span class="unit-name">${esc(unit)}</span>
        <div class="unit-bar-wrap"><div class="unit-bar" style="width:${p}%;background:${color}"></div></div>
        <span class="unit-pct">${p}%</span>
      </div>`;
    }).join('');
    bk.style.display = '';
  } else {
    bk.style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Review
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showReview() {
  filterReview('all', document.querySelector('.rtab'));
  showScreen('s-review');
}

function filterReview(type, tabEl) {
  document.querySelectorAll('.rtab').forEach(t => t.classList.remove('active'));
  if (tabEl) tabEl.classList.add('active');

  const R = S.results;
  if (!R || !R.qs) return;

  const list = document.getElementById('review-list');
  list.innerHTML = '';

  R.qs.forEach((q, i) => {
    const sel = R.ans ? R.ans[i] : S.ans[i];
    const isMulti   = q.answer && q.answer.length > 1;
    const correctSet= new Set(isMulti ? q.answer.split('') : [q.answer]);

    // åˆ¤æ–­ç©º/å¯¹/é”™
    const isEmpty = !sel || (sel instanceof Set && sel.size === 0);
    let isCorrect = false;
    if (!isEmpty) {
      if (isMulti) {
        const selSet = sel instanceof Set ? sel : new Set([sel]);
        isCorrect = selSet.size === correctSet.size && [...correctSet].every(l => selSet.has(l));
      } else {
        isCorrect = sel === q.answer;
      }
    }
    const isSkip = isEmpty;

    if (type === 'wrong' && (isCorrect || isSkip)) return;
    if (type === 'ok'    && (!isCorrect || isSkip)) return;
    if (type === 'skip'  && !isSkip) return;

    const dotClass = isSkip ? 'skip' : isCorrect ? 'ok' : 'err';
    const ansClass  = isSkip ? '' : isCorrect ? 'ok' : 'err';
    // å±•ç¤ºç­”æ¡ˆï¼šå•é€‰æ˜¾ç¤ºå­—æ¯ï¼Œå¤šé€‰æ˜¾ç¤º"A B C"ï¼Œæœªç­”æ˜¾ç¤º"â€”"
    let ansDisplay;
    if (isSkip) {
      ansDisplay = 'â€”';
    } else if (isMulti) {
      const selSet = sel instanceof Set ? sel : new Set([sel]);
      ansDisplay = [...selSet].sort().join('');
    } else {
      ansDisplay = sel;
    }

    const item = document.createElement('div');
    item.className = 'review-item';

    const optsHtml = q.options.map((o, oi) => {
      const l = String.fromCharCode(65 + oi);
      const isCor = correctSet.has(l);
      const selSet = isMulti ? (sel instanceof Set ? sel : new Set()) : null;
      const isSel = isMulti ? selSet.has(l) : sel === l;
      const wrongSel = isSel && !isCor;
      return `<div class="review-opt${isCor ? ' is-correct' : ''}${wrongSel ? ' is-selected wrong' : ''}">
        <span class="review-opt-lbl">${l}</span><span>${esc(o)}</span>
      </div>`;
    }).join('');

    const multiTag = isMulti ? `<span style="font-size:10px;color:var(--warning);margin-left:4px">[å¤šé€‰]</span>` : '';

    item.innerHTML = `
      <div class="review-item-head">
        <span class="review-dot ${dotClass}"></span>
        <span class="review-item-q"><b>${i+1}.</b>${multiTag} ${esc(q.text)}</span>
        <span class="review-ans ${ansClass}" style="min-width:${isMulti?'auto':'20px'};font-size:${isMulti?'11px':'12px'}">${ansDisplay}</span>
      </div>
      <div class="review-expand" id="rexp-${i}">
        <div class="review-expand-inner">
          ${isMulti ? `<div style="font-size:12px;color:var(--muted);margin-bottom:8px">æ­£ç¡®ç­”æ¡ˆï¼š<span style="color:var(--success);font-weight:700">${q.answer.split('').join(' ')}</span></div>` : ''}
          <div class="review-opts-list">${optsHtml}</div>
          <div class="review-discuss">${q.discuss ? `<strong>è§£æï¼š</strong>${esc(q.discuss)}` : 'æš‚æ— è§£æ'}
            ${q.point ? `<br><span style="color:var(--accent);font-size:12px">è€ƒç‚¹ï¼š${esc(q.point)}</span>` : ''}
          </div>
        </div>
      </div>`;

    item.querySelector('.review-item-head').onclick = () => {
      document.getElementById(`rexp-${i}`).classList.toggle('open');
    };
    list.appendChild(item);
  });

  if (!list.children.length) {
    list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px;font-size:14px">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®</div>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// History
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadHistory() {
  try { S.history = JSON.parse(localStorage.getItem('quiz-history') || '[]'); } catch { S.history = []; }
}

function renderHistorySection() {
  const sec = document.getElementById('recent-section');
  const list = document.getElementById('recent-list');
  if (!S.history.length) { sec.style.display = 'none'; return; }
  sec.style.display = '';
  const modeIcon = { practice:'âœï¸', exam:'â±', memo:'ğŸ§ ' };
  list.innerHTML = S.history.slice(0, 5).map(h => `
    <div class="recent-item">
      <div class="recent-info">
        <div class="recent-name">${modeIcon[h.mode]||''} ${h.date} Â· ${h.units || 'å…¨éƒ¨ç« èŠ‚'}</div>
        <div class="recent-meta">${h.total} é¢˜ Â· ç”¨æ—¶ ${formatTime(h.timeSec)}</div>
      </div>
      <div class="recent-score">${h.pct}%</div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Theme
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme() {
  const cur = document.documentElement.getAttribute('data-theme');
  const next = cur === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('quiz-theme', next);
}
function loadTheme() {
  const t = localStorage.getItem('quiz-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Keyboard shortcuts
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  const active = document.querySelector('.screen.active')?.id;
  if (active === 's-quiz') {
    if ('1234'.includes(e.key)) {
      const i = Number(e.key) - 1;
      const opts = document.querySelectorAll('.opt:not(:disabled)');
      if (opts[i]) opts[i].click();
    }
    if ('abcdABCD'.includes(e.key)) {
      const i = e.key.toUpperCase().charCodeAt(0) - 65;
      const opts = document.querySelectorAll('.opt:not(:disabled)');
      if (opts[i]) opts[i].click();
    }
    if (e.key === 'ArrowRight' || e.key === 'Enter') {
      const btn = document.getElementById('btn-next');
      if (!btn.disabled) btn.click();
    }
    if (e.key === 'ArrowLeft') {
      const btn = document.getElementById('btn-prev');
      if (!btn.disabled) btn.click();
    }
    if (e.key === 'f' || e.key === 'F') toggleFlag();
  }
  if (active === 's-memo') {
    if (e.key === ' ' || e.key === 'Enter') {
      e.preventDefault();
      if (!S.memoRevealed) memoReveal();
      else memoKnow();
    }
    if (e.key === 'ArrowLeft' || e.key === 'r' || e.key === 'R') {
      if (S.memoRevealed) memoAgain();
    }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utils
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function formatTime(sec) {
  if (sec < 60) return sec + 'ç§’';
  const m = Math.floor(sec / 60), s = sec % 60;
  return s > 0 ? `${m}åˆ†${s}ç§’` : `${m}åˆ†é’Ÿ`;
}

let toastTimer;
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2400);
}

// èƒŒé¢˜ï¼šç‚¹å‡»å¡ç‰‡ä¸»ä½“ä¹Ÿå¯ä»¥æ­ç¤ºç­”æ¡ˆ
document.getElementById('memo-card')?.addEventListener('click', (e) => {
  if (!S.memoRevealed && document.querySelector('.screen.active')?.id === 's-memo') {
    // åªæœ‰ç‚¹å‡»é¢˜ç›®åŒºè§¦å‘æ­ç¤ºï¼ˆé¿å…ç‚¹æŒ‰é’®åŒºæ—¶é‡å¤ï¼‰
    if (!e.target.closest('.memo-rate-row') && !e.target.closest('.memo-reveal-btn')) {
      memoReveal();
    }
  }
});

init();
</script>
</body>
</html>