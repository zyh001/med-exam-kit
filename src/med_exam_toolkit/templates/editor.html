<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>é¢˜åº“ç¼–è¾‘å™¨</title>
<style>
:root,[data-theme="dark"]{
  --bg:         #0d1117;
  --surface:    #161b22;
  --card:       #21262d;
  --border:     #30363d;
  --text:       #e6edf3;
  --muted:      #7d8590;
  --accent:     #4493f8;
  --accent-bg:  rgba(68,147,248,.12);
  --success:    #3fb950;
  --success-bg: rgba(63,185,80,.12);
  --danger:     #f85149;
  --danger-bg:  rgba(248,81,73,.12);
  --warning:    #d29922;
  --warn-bg:    rgba(210,153,34,.12);
  --ai-color:   #d29922;
  --ai-bg:      rgba(210,153,34,.12);
  --shadow:     0 8px 32px rgba(0,0,0,.5);
  --shadow-sm:  0 2px 8px rgba(0,0,0,.35);
  --r:          12px;
  --sidebar-w:  300px;
}
[data-theme="light"]{
  --bg:         #f0f4f8;
  --surface:    #ffffff;
  --card:       #f6f8fa;
  --border:     #d0d7de;
  --text:       #1f2328;
  --muted:      #656d76;
  --accent:     #0969da;
  --accent-bg:  rgba(9,105,218,.1);
  --success:    #1a7f37;
  --success-bg: rgba(26,127,55,.1);
  --danger:     #cf222e;
  --danger-bg:  rgba(207,34,46,.1);
  --warning:    #9a6700;
  --warn-bg:    rgba(154,103,0,.1);
  --ai-color:   #9a6700;
  --ai-bg:      rgba(154,103,0,.1);
  --shadow:     0 4px 16px rgba(0,0,0,.12);
  --shadow-sm:  0 2px 6px rgba(0,0,0,.08);
}
[data-theme="warm"]{
  --bg:         #1a1510;
  --surface:    #231d16;
  --card:       #2c2419;
  --border:     #3d3025;
  --text:       #f5e6d0;
  --muted:      #9a8070;
  --accent:     #f59e0b;
  --accent-bg:  rgba(245,158,11,.12);
  --success:    #4ade80;
  --success-bg: rgba(74,222,128,.12);
  --danger:     #f87171;
  --danger-bg:  rgba(248,113,113,.12);
  --warning:    #fb923c;
  --warn-bg:    rgba(251,146,60,.12);
  --ai-color:   #fb923c;
  --ai-bg:      rgba(251,146,60,.12);
  --shadow:     0 8px 32px rgba(0,0,0,.6);
  --shadow-sm:  0 2px 8px rgba(0,0,0,.4);
}
[data-theme="terminal"]{
  --bg:         #0a0f0a;
  --surface:    #0d130d;
  --card:       #111811;
  --border:     #1a2e1a;
  --text:       #bbf7d0;
  --muted:      #4a7a4a;
  --accent:     #22c55e;
  --accent-bg:  rgba(34,197,94,.12);
  --success:    #4ade80;
  --success-bg: rgba(74,222,128,.12);
  --danger:     #f87171;
  --danger-bg:  rgba(248,113,113,.12);
  --warning:    #86efac;
  --warn-bg:    rgba(134,239,172,.12);
  --ai-color:   #86efac;
  --ai-bg:      rgba(134,239,172,.12);
  --shadow:     0 8px 32px rgba(0,0,0,.7);
  --shadow-sm:  0 2px 8px rgba(0,0,0,.5);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reset & Base
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text)}
body{
  font-family:'PingFang SC','Hiragino Sans GB','Microsoft YaHei',sans-serif;
  font-size:14px;line-height:1.6;
  display:flex;flex-direction:column;
  transition:background .25s,color .25s;
}
button{cursor:pointer;font-family:inherit;border:none;outline:none;transition:all .15s}
input,select,textarea{font-family:inherit;outline:none;transition:border-color .15s,background .2s}

/* æ»šåŠ¨æ¡ */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   é¡¶æ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#topbar{
  display:flex;align-items:center;gap:10px;
  padding:0 20px;height:56px;flex-shrink:0;
  background:var(--surface);border-bottom:1px solid var(--border);
  position:relative;z-index:50;
}

/* å“ç‰ŒåŒº */
.topbar-brand{display:flex;align-items:center;gap:10px;flex-shrink:0}
.brand-icon{
  width:34px;height:34px;border-radius:9px;flex-shrink:0;
  background:linear-gradient(135deg,var(--accent),#6177f9);
  display:flex;align-items:center;justify-content:center;
  font-size:15px;font-weight:900;color:#fff;
  box-shadow:0 3px 10px rgba(68,147,248,.35);
}
.brand-title{font-size:15px;font-weight:700;letter-spacing:-.3px}
.brand-sub{font-size:11px;color:var(--muted);margin-top:1px}

/* æ–‡ä»¶å + ç»Ÿè®¡ */
.topbar-meta{
  flex:1;min-width:0;display:flex;align-items:center;gap:10px;
  padding:0 4px;
}
.bank-name{
  font-size:13px;color:var(--muted);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;min-width:0;
}
#topStats{
  font-size:12px;color:var(--muted);white-space:nowrap;flex-shrink:0;
}
/* æœªä¿å­˜æŒ‡ç¤ºç‚¹ */
.dirty-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--warning);display:none;flex-shrink:0;
  box-shadow:0 0 6px var(--warning);
  animation:pulse-dot 1.6s ease infinite;
}
.dirty-dot.show{display:block}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}

/* é¡¶æ æŒ‰é’® */
.top-btn{
  padding:7px 16px;border-radius:9px;
  font-size:13px;font-weight:600;white-space:nowrap;flex-shrink:0;
  border:1px solid transparent;
}
.top-btn:hover{opacity:.88}
.top-btn:active{transform:scale(.96)}
#btnSave{
  background:linear-gradient(135deg,var(--accent),#6177f9);
  color:#fff;box-shadow:0 2px 8px rgba(68,147,248,.3);border:none;
}
#btnSave:disabled{background:var(--card);color:var(--muted);box-shadow:none;border:1px solid var(--border);cursor:default;opacity:.6}
#btnReplace{
  background:var(--card);color:var(--text);border-color:var(--border);
}
#btnReplace:hover{border-color:var(--accent);color:var(--accent)}

/* ä¸»é¢˜æŒ‰é’® */
#btnTheme{
  width:36px;height:36px;border-radius:9px;flex-shrink:0;
  background:var(--card);border:1px solid var(--border);
  color:var(--muted);font-size:16px;
  display:flex;align-items:center;justify-content:center;
}
#btnTheme:hover{border-color:var(--accent);color:var(--accent)}

/* ä¸»é¢˜ä¸‹æ‹‰èœå• */
#themeMenu{
  position:absolute;top:calc(56px + 8px);right:20px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:6px;
  display:none;flex-direction:column;gap:3px;
  z-index:200;box-shadow:var(--shadow);min-width:160px;
}
#themeMenu.open{display:flex}
.theme-opt{
  display:flex;align-items:center;gap:10px;
  padding:9px 12px;border-radius:8px;cursor:pointer;
  font-size:13px;transition:background .1s;
}
.theme-opt:hover{background:var(--card)}
.theme-opt.active{background:var(--accent-bg);color:var(--accent)}
.theme-swatch{
  width:26px;height:16px;border-radius:5px;flex-shrink:0;
  border:1px solid rgba(128,128,128,.2);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ä¸»å¸ƒå±€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#layout{
  display:flex;flex:1;min-height:0;
  height:calc(100vh - 56px);overflow:hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å·¦ä¾§æ 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  display:flex;flex-direction:column;
  border-right:1px solid var(--border);
  background:var(--surface);
  overflow:hidden;min-height:0;
}

/* æœç´¢åŒº */
#search-area{
  padding:12px 14px;display:flex;flex-direction:column;gap:8px;
  border-bottom:1px solid var(--border);flex-shrink:0;
  background:var(--surface);
}
.search-field{
  display:flex;align-items:center;gap:8px;
  background:var(--card);border:1.5px solid var(--border);border-radius:9px;
  padding:0 10px;transition:border-color .15s;
}
.search-field:focus-within{border-color:var(--accent)}
.search-icon{font-size:13px;color:var(--muted);flex-shrink:0}
.search-field input{
  flex:1;background:transparent;border:none;color:var(--text);
  font-size:13px;padding:8px 0;
}
.search-field input::placeholder{color:var(--muted)}
.search-field input:focus{outline:none}

#fpInput{
  background:var(--card);border:1.5px solid var(--border);
  border-radius:9px;padding:7px 10px;
  color:var(--text);font-size:11px;
  font-family:ui-monospace,'SF Mono',monospace;
  width:100%;letter-spacing:.03em;
}
#fpInput::placeholder{color:var(--muted)}
#fpInput:focus{border-color:var(--accent)}

.filter-row{display:flex;gap:6px}
.filter-select{
  flex:1;min-width:0;
  background:var(--card);border:1.5px solid var(--border);
  color:var(--text);border-radius:8px;padding:6px 10px;
  font-size:12px;
}
.filter-select:focus{border-color:var(--accent)}

.filter-checks{display:flex;gap:12px;flex-wrap:wrap;padding:2px 0}
.filter-checks label{
  display:flex;align-items:center;gap:5px;
  font-size:12px;color:var(--muted);cursor:pointer;
  transition:color .15s;user-select:none;
}
.filter-checks label:hover{color:var(--text)}
.filter-checks input[type="checkbox"]{accent-color:var(--accent)}

/* ç»“æœè®¡æ•° */
#result-count{
  font-size:11px;color:var(--muted);
  padding:6px 14px;border-bottom:1px solid var(--border);
  flex-shrink:0;background:var(--card);
  letter-spacing:.02em;
}

/* é¢˜ç›®åˆ—è¡¨ */
#qlist{flex:1;overflow-y:auto;min-height:0}
.q-item{
  padding:11px 14px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .12s;
}
.q-item:hover{background:var(--card)}
.q-item.active{
  background:var(--accent-bg);
  border-left:3px solid var(--accent);
  padding-left:11px;
}
.q-item-header{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px}
.q-idx{
  font-size:10px;color:var(--muted);
  font-family:ui-monospace,monospace;letter-spacing:.04em;
}
.q-meta{display:flex;align-items:baseline;gap:4px}
.q-mode{
  font-size:10px;color:var(--accent);
  font-family:ui-monospace,monospace;
}
.q-fp{
  font-size:9px;color:var(--border);
  font-family:ui-monospace,monospace;letter-spacing:.02em;
}
.q-text{
  font-size:12px;line-height:1.5;color:var(--text);
  overflow:hidden;display:-webkit-box;
  -webkit-line-clamp:2;-webkit-box-orient:vertical;
}
.q-badges{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap}
.badge{
  font-size:10px;padding:1px 7px;border-radius:5px;
  font-weight:600;letter-spacing:.02em;
}
.badge.ai{background:var(--ai-bg);color:var(--ai-color)}
.badge.miss{background:var(--danger-bg);color:var(--danger)}

/* åˆ†é¡µ */
#pagination{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;border-top:1px solid var(--border);
  background:var(--surface);flex-shrink:0;gap:6px;
}
.page-btn{
  background:var(--card);border:1px solid var(--border);
  color:var(--text);border-radius:7px;padding:4px 12px;
  font-size:12px;font-weight:600;
}
.page-btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent)}
.page-btn:disabled{opacity:.35;cursor:default}
#pageInfo{font-size:12px;color:var(--muted);flex:1;text-align:center}
.page-jump{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted)}
#jumpInput{
  width:38px;background:var(--card);border:1px solid var(--border);
  color:var(--text);border-radius:6px;padding:3px 5px;
  font-size:11px;text-align:center;
}
#jumpInput:focus{border-color:var(--accent)}

/* ç§»åŠ¨ç«¯è¿”å›æŒ‰é’® */
#mobileBack{
  display:none;align-items:center;gap:8px;
  padding:10px 16px;border-bottom:1px solid var(--border);
  font-size:13px;color:var(--accent);cursor:pointer;
  background:var(--surface);flex-shrink:0;font-weight:500;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å³ä¾§ç¼–è¾‘åŒº
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#editor{
  flex:1;min-width:0;min-height:0;
  overflow-y:auto;overflow-x:hidden;
  padding:20px 24px 40px;
  display:flex;flex-direction:column;gap:14px;
  background:var(--bg);
}
.empty{
  color:var(--muted);text-align:center;
  margin-top:100px;font-size:14px;line-height:2;
}
.empty-icon{font-size:32px;margin-bottom:10px;display:block;opacity:.5}

/* â”€â”€ å¡ç‰‡å¼ Section â”€â”€ */
.section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;flex-shrink:0;
}
.section-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 16px;border-bottom:1px solid var(--border);
  background:var(--card);
}
.sec-title{
  font-size:11px;font-weight:700;color:var(--muted);
  text-transform:uppercase;letter-spacing:.08em;
}
.sec-fp{
  font-size:10px;font-family:ui-monospace,monospace;
  color:var(--muted);letter-spacing:.04em;
  cursor:pointer;user-select:all;
  padding:3px 8px;border-radius:5px;
  background:var(--border);transition:background .15s,color .15s;
}
.sec-fp:hover{background:var(--accent-bg);color:var(--accent)}
.section-body{padding:16px}

/* â”€â”€ è¡¨å•å…ƒç´  â”€â”€ */
.meta-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.field-group{display:flex;flex-direction:column;gap:5px}
.field-label{
  font-size:11px;font-weight:600;color:var(--muted);
  text-transform:uppercase;letter-spacing:.06em;
}
.field-input{
  background:var(--card);border:1.5px solid var(--border);
  color:var(--text);border-radius:9px;padding:8px 12px;font-size:13px;
  width:100%;
}
.field-input:focus{border-color:var(--accent);outline:none}
.field-input::placeholder{color:var(--muted)}
textarea.field-input{resize:vertical;min-height:80px;line-height:1.7}
textarea.field-input.tall{min-height:120px}

/* â”€â”€ é€‰é¡¹åˆ—è¡¨ â”€â”€ */
.options-list{display:flex;flex-direction:column;gap:7px}
.option-row{display:flex;align-items:center;gap:8px}
.option-label{
  width:28px;height:28px;border-radius:7px;flex-shrink:0;
  background:var(--accent-bg);color:var(--accent);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;
}
.option-input{
  flex:1;min-width:0;background:var(--card);
  border:1.5px solid var(--border);color:var(--text);
  border-radius:9px;padding:7px 12px;font-size:13px;
}
.option-input:focus{border-color:var(--accent);outline:none}
.btn-icon{
  width:28px;height:28px;border-radius:7px;flex-shrink:0;
  background:transparent;color:var(--muted);font-size:13px;
  display:flex;align-items:center;justify-content:center;
  transition:background .12s,color .12s;
}
.btn-icon:hover{background:var(--danger-bg);color:var(--danger)}

/* â”€â”€ ç­”æ¡ˆ/è€ƒç‚¹è¡Œ â”€â”€ */
.answer-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start}

/* â”€â”€ AI æ ‡è®° â”€â”€ */
.ai-badge{
  font-size:10px;font-weight:700;
  color:var(--ai-color);background:var(--ai-bg);
  padding:2px 7px;border-radius:5px;
  vertical-align:middle;margin-left:4px;
}

/* â”€â”€ æ“ä½œæ  â”€â”€ */
.action-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

/* â”€â”€ æŒ‰é’® â”€â”€ */
.btn{
  padding:9px 20px;border-radius:9px;
  font-size:13px;font-weight:700;border:none;
}
.btn:hover{opacity:.88}
.btn:active{transform:scale(.96)}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),#6177f9);
  color:#fff;box-shadow:0 3px 10px rgba(68,147,248,.3);
}
.btn-danger{
  background:var(--danger-bg);color:var(--danger);
  border:1.5px solid var(--danger);
}
.btn-danger:hover{background:var(--danger);color:#fff;opacity:1}
.btn-ghost{
  background:var(--card);color:var(--text);
  border:1.5px solid var(--border);
}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);opacity:1}

/* â”€â”€ å­é¢˜æ ‡ç­¾ â”€â”€ */
.sub-tabs{display:flex;gap:6px;flex-wrap:wrap}
.sub-tab{
  padding:5px 14px;border-radius:8px;cursor:pointer;
  font-size:12px;font-weight:600;
  background:var(--card);border:1.5px solid var(--border);color:var(--muted);
  transition:all .15s;
}
.sub-tab:hover{border-color:var(--accent);color:var(--accent)}
.sub-tab.active{background:var(--accent-bg);border-color:var(--accent);color:var(--accent)}

/* â”€â”€ åˆ†éš”ç¬¦ â”€â”€ */
.field-divider{
  height:1px;background:var(--border);margin:4px 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å¼¹çª—
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.65);
  z-index:100;display:flex;align-items:center;justify-content:center;
  backdrop-filter:blur(4px);padding:20px;
}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:16px;width:100%;max-width:500px;
  max-height:90vh;overflow-y:auto;
  padding:24px;display:flex;flex-direction:column;gap:16px;
  box-shadow:var(--shadow);
}
.modal-title{
  font-size:17px;font-weight:700;color:var(--text);
  display:flex;align-items:center;gap:8px;
}
.modal-title-icon{
  width:32px;height:32px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;font-size:16px;
}
.modal-title-icon.danger{background:var(--danger-bg)}
.modal-title-icon.primary{background:var(--accent-bg)}
.modal-desc{font-size:13px;color:var(--muted);line-height:1.7}
.modal-btns{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
.checkbox-group{display:flex;gap:10px;flex-wrap:wrap}
.checkbox-group label{
  display:flex;align-items:center;gap:5px;
  font-size:12px;color:var(--muted);cursor:pointer;
}
.checkbox-group input[type="checkbox"]{accent-color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(8px);
  background:var(--surface);border:1px solid var(--border);
  border-radius:10px;padding:11px 20px;
  font-size:13px;color:var(--text);font-weight:500;
  z-index:300;opacity:0;pointer-events:none;
  transition:all .25s;white-space:nowrap;
  box-shadow:var(--shadow);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
#toast.err{border-color:var(--danger);color:var(--danger);background:var(--danger-bg)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç§»åŠ¨ç«¯å“åº”å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:768px){
  #topbar{padding:0 14px;gap:8px;height:52px}
  .brand-sub{display:none}
  #topStats{display:none}
  #layout{position:relative;height:calc(100dvh - 52px)}
  #sidebar{
    position:absolute;inset:0;width:100%;border-right:none;
    z-index:10;transition:transform .25s cubic-bezier(.4,0,.2,1);
  }
  #editor{
    position:absolute;inset:0;padding:14px 16px 32px;
    transform:translateX(100%);
    transition:transform .25s cubic-bezier(.4,0,.2,1);
    background:var(--bg);overflow-y:auto;
    -webkit-overflow-scrolling:touch;
  }
  body.editor-open #sidebar{transform:translateX(-100%)}
  body.editor-open #editor{transform:translateX(0)}
  #mobileBack{display:flex}
  .meta-grid{grid-template-columns:1fr}
  .answer-row{grid-template-columns:1fr}
  .modal{padding:18px;border-radius:14px}
  .modal-btns{justify-content:stretch}
  .modal-btns .btn{flex:1}
  #themeMenu{right:14px}
}
@media(min-width:1200px){
  :root{--sidebar-w:340px}
}
</style>
</head>
<body>

<!-- â•â•â• é¡¶æ  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="topbar">
  <div class="topbar-brand">
    <div class="brand-icon">ç¼–</div>
    <div>
      <div class="brand-title">é¢˜åº“ç¼–è¾‘å™¨</div>
    </div>
  </div>

  <div class="topbar-meta">
    <span class="bank-name" id="bankName">åŠ è½½ä¸­â€¦</span>
    <span id="topStats"></span>
    <div class="dirty-dot" id="dirtyDot" title="æœ‰æœªä¿å­˜çš„æ”¹åŠ¨"></div>
  </div>

  <button class="top-btn" id="btnReplace" onclick="openReplace()">æ‰¹é‡æ›¿æ¢</button>
  <button class="top-btn" id="btnSave" onclick="doSave()">ä¿å­˜</button>
  <button id="btnTheme" onclick="toggleThemeMenu()" title="åˆ‡æ¢ä¸»é¢˜">ğŸ¨</button>
</div>

<!-- ä¸»é¢˜é€‰æ‹©èœå• -->
<div id="themeMenu">
  <div class="theme-opt" data-t="dark">
    <span class="theme-swatch" style="background:linear-gradient(135deg,#0d1117 50%,#4493f8 50%)"></span>
    å¤œé—´
  </div>
  <div class="theme-opt" data-t="light">
    <span class="theme-swatch" style="background:linear-gradient(135deg,#f0f4f8 50%,#0969da 50%)"></span>
    æ—¥é—´
  </div>
  <div class="theme-opt" data-t="warm">
    <span class="theme-swatch" style="background:linear-gradient(135deg,#1a1510 50%,#f59e0b 50%)"></span>
    æš–è°ƒ
  </div>
  <div class="theme-opt" data-t="terminal">
    <span class="theme-swatch" style="background:linear-gradient(135deg,#0a0f0a 50%,#22c55e 50%)"></span>
    ç»ˆç«¯
  </div>
</div>

<!-- â•â•â• ä¸»å¸ƒå±€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="layout">

  <!-- å·¦ä¾§æ  -->
  <div id="sidebar">
    <div id="search-area">
      <!-- å…¨æ–‡æœç´¢ -->
      <div class="search-field">
        <span class="search-icon">ğŸ”</span>
        <input id="searchInput" placeholder="æœç´¢é¢˜ç›®æ–‡å­—ã€è§£æâ€¦" oninput="debounceSearch()">
      </div>
      <!-- æŒ‡çº¹æœç´¢ -->
      <input id="fpInput" placeholder="æŒ‡çº¹æœç´¢ï¼ˆå‰ç¼€æˆ–å®Œæ•´ MD5ï¼‰" oninput="debounceSearch()">
      <!-- ç­›é€‰ -->
      <div class="filter-row">
        <select class="filter-select" id="filterMode" onchange="loadList()">
          <option value="">å…¨éƒ¨é¢˜å‹</option>
        </select>
        <select class="filter-select" id="filterUnit" onchange="loadList()">
          <option value="">å…¨éƒ¨ç« èŠ‚</option>
        </select>
      </div>
      <div class="filter-checks">
        <label><input type="checkbox" id="filterAI" onchange="loadList()"> å« AI å†…å®¹</label>
        <label><input type="checkbox" id="filterMissing" onchange="loadList()"> ç¼ºç­”æ¡ˆ/è§£æ</label>
      </div>
    </div>

    <div id="result-count"></div>
    <div id="qlist"></div>

    <div id="pagination">
      <button class="page-btn" id="btnPrev" onclick="prevPage()">â€¹</button>
      <span id="pageInfo"></span>
      <button class="page-btn" id="btnNext" onclick="nextPage()">â€º</button>
      <div class="page-jump">
        <span>è·³è½¬</span>
        <input id="jumpInput" type="number" min="1" placeholder="é¡µ"
               onkeydown="if(event.key==='Enter')jumpPage(this.value)">
      </div>
    </div>
  </div>

  <!-- å³ä¾§ç¼–è¾‘åŒº -->
  <div id="editor">
    <div id="mobileBack" onclick="closeMobileEditor()">â† è¿”å›åˆ—è¡¨</div>
    <div class="empty" id="emptyHint">
      <span class="empty-icon">âœ</span>
      ä»å·¦ä¾§é€‰æ‹©ä¸€é“é¢˜ç›®å¼€å§‹ç¼–è¾‘
    </div>
  </div>
</div>

<!-- â•â•â• æ‰¹é‡æ›¿æ¢å¼¹çª— â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="replaceModal" style="display:none"
     onclick="if(event.target===this)closeReplace()">
  <div class="modal">
    <div class="modal-title">
      <div class="modal-title-icon primary">ğŸ”„</div>
      æ‰¹é‡æ›¿æ¢
    </div>

    <div class="field-group">
      <span class="field-label">æŸ¥æ‰¾æ–‡æœ¬</span>
      <input class="field-input" id="rFind" placeholder="è¾“å…¥è¦æŸ¥æ‰¾çš„æ–‡æœ¬">
    </div>
    <div class="field-group">
      <span class="field-label">æ›¿æ¢ä¸º</span>
      <input class="field-input" id="rReplace" placeholder="æ›¿æ¢åçš„æ–‡æœ¬ï¼ˆç•™ç©ºå³åˆ é™¤ï¼‰">
    </div>
    <div class="field-group">
      <span class="field-label">ä½œç”¨å­—æ®µ</span>
      <div class="checkbox-group">
        <label><input type="checkbox" value="text" checked> é¢˜ç›®æ–‡å­—</label>
        <label><input type="checkbox" value="discuss" checked> è§£æ</label>
        <label><input type="checkbox" value="answer"> ç­”æ¡ˆ</label>
        <label><input type="checkbox" value="point"> è€ƒç‚¹</label>
      </div>
    </div>
    <div class="field-group">
      <span class="field-label">èŒƒå›´é™åˆ¶ï¼ˆå¯é€‰ï¼‰</span>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select class="field-input" id="rMode" style="flex:1;min-width:120px">
          <option value="">å…¨éƒ¨é¢˜å‹</option>
        </select>
        <select class="field-input" id="rUnit" style="flex:1;min-width:120px">
          <option value="">å…¨éƒ¨ç« èŠ‚</option>
        </select>
      </div>
    </div>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeReplace()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="doReplace()">æ‰§è¡Œæ›¿æ¢</button>
    </div>
  </div>
</div>

<!-- â•â•â• åˆ é™¤ç¡®è®¤å¼¹çª— â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="deleteModal" style="display:none">
  <div class="modal">
    <div class="modal-title">
      <div class="modal-title-icon danger">ğŸ—‘</div>
      ç¡®è®¤åˆ é™¤
    </div>
    <p class="modal-desc">åˆ é™¤åä¸å¯æ’¤é”€ï¼ˆä¿å­˜å‰å¯å…³é—­é¡µé¢æ”¾å¼ƒæ›´æ”¹ï¼‰ã€‚ç¡®å®šè¦åˆ é™¤è¿™é“é¢˜å—ï¼Ÿ</p>
    <div class="modal-btns">
      <button class="btn btn-ghost" onclick="closeDelete()">å–æ¶ˆ</button>
      <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// â”€â”€ çŠ¶æ€ â”€â”€
let state = { page: 1, perPage: 50, total: 0, pages: 0 };
let currentQi = null, currentSi = 0;
let deleteTarget = null;
let searchTimer = null;
let info = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸»é¢˜ç®¡ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const THEMES = ['dark','light','warm','terminal'];
const THEME_LABELS = { dark:'å¤œé—´', light:'æ—¥é—´', warm:'æš–è°ƒ', terminal:'ç»ˆç«¯' };

function applyTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('editor-theme', t);
  // æ›´æ–°èœå•é«˜äº®
  document.querySelectorAll('.theme-opt').forEach(el => {
    el.classList.toggle('active', el.dataset.t === t);
  });
}

function toggleThemeMenu() {
  const menu = document.getElementById('themeMenu');
  menu.classList.toggle('open');
}

function closeThemeMenu() {
  document.getElementById('themeMenu').classList.remove('open');
}

// ç‚¹å‡»èœå•å¤–å…³é—­
document.addEventListener('click', e => {
  if (!e.target.closest('#themeMenu') && !e.target.closest('#btnTheme')) {
    closeThemeMenu();
  }
});

// ç‚¹å‡»ä¸»é¢˜é€‰é¡¹
document.querySelectorAll('.theme-opt').forEach(el => {
  el.onclick = () => {
    applyTheme(el.dataset.t);
    closeThemeMenu();
  };
});

// åˆå§‹åŒ–æ—¶æ¢å¤ä¸Šæ¬¡ä¸»é¢˜
(function() {
  const saved = localStorage.getItem('editor-theme') || 'dark';
  applyTheme(saved);
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// åˆå§‹åŒ–
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  info = await fetch('/api/info').then(r => r.json());
  document.getElementById('bankName').textContent = info.bank_path.split(/[\\\/]/).pop();
  updateTopStats();
  populateFilters();
  loadList();
}

function populateFilters() {
  ['filterMode','rMode'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">å…¨éƒ¨é¢˜å‹</option>';
    info.modes.forEach(m => sel.add(new Option(m, m)));
  });
  ['filterUnit','rUnit'].forEach(id => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">å…¨éƒ¨ç« èŠ‚</option>';
    info.units.forEach(u => sel.add(new Option(u, u)));
  });
}

function updateTopStats() {
  document.getElementById('topStats').textContent =
    `${info.total_q} å¤§é¢˜ / ${info.total_sq} å°é¢˜`;
  document.getElementById('dirtyDot').className = 'dirty-dot' + (info.dirty ? ' show' : '');
  document.getElementById('btnSave').disabled = !info.dirty;
}

function openMobileEditor()  { if (window.innerWidth <= 768) document.body.classList.add('editor-open'); }
function closeMobileEditor() { document.body.classList.remove('editor-open'); }

// â”€â”€ åˆ—è¡¨ â”€â”€
async function loadList() {
  const q       = document.getElementById('searchInput').value;
  const fp      = document.getElementById('fpInput').value.trim();
  const mode    = document.getElementById('filterMode').value;
  const unit    = document.getElementById('filterUnit').value;
  const hasAI   = document.getElementById('filterAI').checked ? '1' : '';
  const missing = document.getElementById('filterMissing').checked ? '1' : '';

  const params = new URLSearchParams({
    q, fp, mode, unit, has_ai: hasAI, missing, page: state.page, per_page: state.perPage
  });
  const data = await fetch('/api/questions?' + params).then(r => r.json());

  state.total = data.total;
  state.pages = data.pages;

  document.getElementById('result-count').textContent = `å…± ${data.total} ä¸ªå°é¢˜`;
  document.getElementById('pageInfo').textContent = `${state.page} / ${Math.max(1, state.pages)}`;
  document.getElementById('btnPrev').disabled = state.page <= 1;
  document.getElementById('btnNext').disabled = state.page >= state.pages;

  const list = document.getElementById('qlist');
  list.innerHTML = '';
  data.items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'q-item' + (item.qi === currentQi && item.si === currentSi ? ' active' : '');
    div.onclick = () => selectQuestion(item.qi, item.si);

    const hasAIBadge = item.ai_discuss || item.ai_answer;
    const badges = [
      hasAIBadge                      ? `<span class="badge ai">AI</span>`     : '',
      item.answer_source  === 'ai'    ? `<span class="badge ai">AIç­”æ¡ˆ</span>` : '',
      item.discuss_source === 'ai'    ? `<span class="badge ai">AIè§£æ</span>` : '',
      (!item.answer || !item.discuss) ? `<span class="badge miss">ç¼º${!item.answer?'ç­”æ¡ˆ':''}${!item.discuss?'è§£æ':''}</span>` : '',
    ].filter(Boolean).join('');

    const fpShort = item.fingerprint ? item.fingerprint.slice(0, 8) : '';
    div.innerHTML = `
      <div class="q-item-header">
        <span class="q-idx">[${item.qi+1}-${item.si+1}]</span>
        <span class="q-meta"><span class="q-mode">${esc(item.mode)}</span><span class="q-fp">${fpShort}</span></span>
      </div>
      <div class="q-text">${esc(item.text || item.stem || 'ï¼ˆæ— é¢˜ç›®æ–‡æœ¬ï¼‰')}</div>
      <div class="q-badges">${badges}</div>`;
    list.appendChild(div);
  });
}

function debounceSearch() {
  clearTimeout(searchTimer);
  state.page = 1;
  searchTimer = setTimeout(loadList, 280);
}
function prevPage() { if (state.page > 1)           { state.page--; loadList(); } }
function nextPage() { if (state.page < state.pages) { state.page++; loadList(); } }
function jumpPage(v) {
  const p = Math.max(1, Math.min(state.pages, parseInt(v) || 1));
  state.page = p;
  document.getElementById('jumpInput').value = '';
  loadList();
}

// â”€â”€ ç¼–è¾‘é¢æ¿ â”€â”€
async function selectQuestion(qi, si) {
  currentQi = qi; currentSi = si;
  document.querySelectorAll('.q-item').forEach(el => {
    el.classList.toggle('active',
      el.querySelector('.q-idx')?.textContent === `[${qi+1}-${si+1}]`);
  });
  const data = await fetch(`/api/question/${qi}`).then(r => r.json());
  renderEditor(data, si);
  openMobileEditor();
}

function renderEditor(data, activeSi = 0) {
  const ed = document.getElementById('editor');
  ed.innerHTML = '';

  const back = document.createElement('div');
  back.id = 'mobileBack';
  back.textContent = 'â† è¿”å›åˆ—è¡¨';
  back.onclick = closeMobileEditor;
  ed.appendChild(back);

  // å…ƒæ•°æ®
  const metaSection = mkSection('å…ƒæ•°æ®', `
    <div class="meta-grid">
      <div class="field-group">
        <span class="field-label">é¢˜å‹</span>
        <input class="field-input" id="f_mode" value="${esc(data.mode)}">
      </div>
      <div class="field-group">
        <span class="field-label">ç« èŠ‚</span>
        <input class="field-input" id="f_unit" value="${esc(data.unit)}">
      </div>
      <div class="field-group">
        <span class="field-label">åˆ†ç±»</span>
        <input class="field-input" id="f_cls" value="${esc(data.cls)}">
      </div>
    </div>
    ${data.stem ? `
    <div class="field-group" style="margin-top:12px">
      <span class="field-label">å…±äº«é¢˜å¹²</span>
      <textarea class="field-input tall" id="f_stem">${esc(data.stem)}</textarea>
    </div>` : ''}
  `);
  const fp0 = data.sub_questions[0]?.fingerprint || '';
  if (fp0) {
    const fpEl = document.createElement('span');
    fpEl.className = 'sec-fp';
    fpEl.title = 'ç‚¹å‡»å¤åˆ¶å®Œæ•´æŒ‡çº¹ï¼š' + fp0;
    fpEl.textContent = fp0.slice(0, 12) + 'â€¦';
    fpEl.onclick = () => navigator.clipboard?.writeText(fp0).then(() => toast('å·²å¤åˆ¶æŒ‡çº¹'));
    metaSection.querySelector('.section-header').appendChild(fpEl);
  }
  ed.appendChild(metaSection);

  // å­é¢˜åˆ‡æ¢
  if (data.sub_questions.length > 1) {
    const tabsDiv = document.createElement('div');
    tabsDiv.className = 'section';
    tabsDiv.innerHTML = `<div class="section-body"><div class="sub-tabs">
      ${data.sub_questions.map((sq, i) => `
        <div class="sub-tab ${i === activeSi ? 'active' : ''}" onclick="selectSub(${data.qi},${i})">
          å­é¢˜ ${i+1}${!sq.answer ? ' â“' : ''}
        </div>`).join('')}
    </div></div>`;
    ed.appendChild(tabsDiv);
  }

  const sq = data.sub_questions[activeSi];
  currentSi = activeSi;

  ed.appendChild(mkSection('é¢˜ç›®æ–‡å­—', `
    <textarea class="field-input tall" id="f_text">${esc(sq.text)}</textarea>
  `));

  const optHtml = sq.options.map((o, i) =>
    `<div class="option-row">
      <span class="option-label">${String.fromCharCode(65+i)}</span>
      <input class="option-input" value="${esc(o)}" data-oi="${i}">
      <button class="btn-icon" onclick="removeOption(${i})" title="åˆ é™¤">âœ•</button>
    </div>`
  ).join('');
  ed.appendChild(mkSection('é€‰é¡¹', `
    <div class="options-list" id="optionsList">${optHtml}</div>
    <button class="btn btn-ghost" style="margin-top:12px;font-size:12px" onclick="addOption()">ï¼‹ æ·»åŠ é€‰é¡¹</button>
  `));

  const aiAnsBadge = sq.ai_answer  ? `<span class="ai-badge">AI: ${esc(sq.ai_answer)}</span>`  : '';
  const aiDisBadge = sq.ai_discuss ? `<span class="ai-badge">AI</span>` : '';
  ed.appendChild(mkSection('ç­”æ¡ˆä¸è§£æ', `
    <div class="answer-row">
      <div class="field-group">
        <span class="field-label">ç­”æ¡ˆ ${aiAnsBadge}</span>
        <input class="field-input" id="f_answer" value="${esc(sq.answer)}"
               style="${sq.answer_source==='ai' ? 'border-color:var(--ai-color)' : ''}">
      </div>
      <div class="field-group">
        <span class="field-label">è€ƒç‚¹</span>
        <input class="field-input" id="f_point" value="${esc(sq.point)}">
      </div>
    </div>
    <div class="field-group" style="margin-top:14px">
      <span class="field-label">è§£æ ${aiDisBadge}</span>
      <textarea class="field-input tall" id="f_discuss"
        style="${sq.discuss_source==='ai' ? 'border-color:var(--ai-color)' : ''}">${esc(sq.discuss)}</textarea>
    </div>
    ${sq.ai_discuss ? `
    <div class="field-group" style="margin-top:12px">
      <span class="field-label" style="color:var(--ai-color)">AI è§£æåŸæ–‡ï¼ˆåªè¯»å‚è€ƒï¼‰</span>
      <textarea class="field-input tall" readonly
        style="color:var(--ai-color);opacity:.7;cursor:default">${esc(sq.ai_discuss)}</textarea>
    </div>` : ''}
  `));

  const actDiv = document.createElement('div');
  actDiv.className = 'section';
  actDiv.innerHTML = `<div class="section-body"><div class="action-bar">
    <button class="btn btn-primary" onclick="saveSubQuestion()">ä¿å­˜æ­¤é¢˜</button>
    <button class="btn btn-danger"  onclick="openDelete(${data.qi})">åˆ é™¤æ•´é“é¢˜</button>
  </div></div>`;
  ed.appendChild(actDiv);
}

function mkSection(title, bodyHtml) {
  const div = document.createElement('div');
  div.className = 'section';
  div.innerHTML = `
    <div class="section-header"><span class="sec-title">${title}</span></div>
    <div class="section-body">${bodyHtml}</div>`;
  return div;
}

async function selectSub(qi, si) {
  const data = await fetch(`/api/question/${qi}`).then(r => r.json());
  renderEditor(data, si);
}

function getOptions() { return [...document.querySelectorAll('.option-input')].map(i => i.value); }
function addOption() {
  const list = document.getElementById('optionsList');
  const i = list.children.length;
  const row = document.createElement('div');
  row.className = 'option-row';
  row.innerHTML = `
    <span class="option-label">${String.fromCharCode(65+i)}</span>
    <input class="option-input" value="" data-oi="${i}">
    <button class="btn-icon" onclick="removeOption(${i})" title="åˆ é™¤">âœ•</button>`;
  list.appendChild(row);
}
function removeOption(idx) {
  document.getElementById('optionsList').children[idx]?.remove();
  [...document.getElementById('optionsList').children].forEach((row, i) => {
    row.querySelector('.option-label').textContent = String.fromCharCode(65+i);
    row.querySelector('.option-input').dataset.oi = i;
    row.querySelector('.btn-icon').setAttribute('onclick', `removeOption(${i})`);
  });
}

async function saveSubQuestion() {
  const payload = {
    mode:    document.getElementById('f_mode')?.value  ?? '',
    unit:    document.getElementById('f_unit')?.value  ?? '',
    cls:     document.getElementById('f_cls')?.value   ?? '',
    stem:    document.getElementById('f_stem')?.value  ?? '',
    text:    document.getElementById('f_text').value,
    answer:  document.getElementById('f_answer').value,
    discuss: document.getElementById('f_discuss').value,
    point:   document.getElementById('f_point').value,
    options: getOptions(),
  };
  const res = await fetch(`/api/subquestion/${currentQi}/${currentSi}`, {
    method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload),
  }).then(r => r.json());
  if (res.ok) { info.dirty = true; updateTopStats(); loadList(); toast('âœ“ å·²ä¿å­˜'); }
  else toast('ä¿å­˜å¤±è´¥: ' + (res.error || ''), true);
}

function openDelete(qi) { deleteTarget = qi; document.getElementById('deleteModal').style.display = 'flex'; }
function closeDelete()  { document.getElementById('deleteModal').style.display = 'none'; deleteTarget = null; }
async function confirmDelete() {
  if (deleteTarget === null) return;
  const res = await fetch(`/api/question/${deleteTarget}`, { method:'DELETE' }).then(r => r.json());
  closeDelete();
  if (res.ok) {
    currentQi = null; info.dirty = true; info.total_q = res.total;
    updateTopStats(); loadList(); closeMobileEditor();
    document.getElementById('editor').innerHTML =
      '<div id="mobileBack" onclick="closeMobileEditor()">â† è¿”å›åˆ—è¡¨</div>' +
      '<div class="empty"><span class="empty-icon">âœ</span>ä»å·¦ä¾§é€‰æ‹©ä¸€é“é¢˜ç›®å¼€å§‹ç¼–è¾‘</div>';
    toast(`å·²åˆ é™¤ï¼Œå‰©ä½™ ${res.total} å¤§é¢˜`);
  } else toast('åˆ é™¤å¤±è´¥', true);
}

function openReplace()  { document.getElementById('replaceModal').style.display = 'flex'; }
function closeReplace() { document.getElementById('replaceModal').style.display = 'none'; }
async function doReplace() {
  const find   = document.getElementById('rFind').value;
  const repl   = document.getElementById('rReplace').value;
  const fields = [...document.querySelectorAll('.checkbox-group input:checked')].map(c => c.value);
  const mode   = document.getElementById('rMode').value;
  const unit   = document.getElementById('rUnit').value;
  if (!find)          { toast('æŸ¥æ‰¾æ–‡æœ¬ä¸èƒ½ä¸ºç©º', true); return; }
  if (!fields.length) { toast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä½œç”¨å­—æ®µ', true); return; }
  const res = await fetch('/api/replace', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ find, replace: repl, fields, mode, unit }),
  }).then(r => r.json());
  if (res.ok) { info.dirty = true; updateTopStats(); closeReplace(); loadList(); toast(`æ›¿æ¢å®Œæˆï¼šå…± ${res.replaced} å¤„`); }
  else toast('æ›¿æ¢å¤±è´¥: ' + (res.error || ''), true);
}

async function doSave() {
  const res = await fetch('/api/save', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({}),
  }).then(r => r.json());
  if (res.ok) { info.dirty = false; updateTopStats(); toast('âœ“ å·²ä¿å­˜è‡³ ' + res.path.split(/[\\\/]/).pop()); }
  else toast('ä¿å­˜å¤±è´¥: ' + (res.error || ''), true);
}

function esc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
let toastTimer;
function toast(msg, err=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show' + (err ? ' err' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.className = '', 3000);
}

document.addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); if (info.dirty) doSave(); }
});

init();
</script>
</body>
</html>